<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <title>Finance Dash</title>
    <style id="skills-styles">
        /* ========== SKILLS TAB EXCLUSIVE CSS ========== */
        /* CSS variables scoped to skills tab */
        #skills-tab {
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-yellow: #facc15;
            --accent-cyan: #22d3ee;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
            --success: #4ade80;
            --danger: #f87171;
            --warning: #fbbf24;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --glow-blue: 0 0 15px rgba(59, 130, 246, 0.5);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ===== Icon Stats ===== */
        #skills-tab .icon-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
            font-size: 0.75rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
            background: var(--glass-bg);
            padding: 8px 10px;
            border-radius: 12px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(8px);
        }

        /* ===== Tree Layout ===== */
        #skills-tab .skill-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 60px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        #skills-tab .tree-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding: 10px 30px;
            border-radius: 12px;
        }
        #skills-tab .tree-title.tech {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(34, 211, 238, 0.2));
            border: 1px solid var(--accent-blue);
        }
        #skills-tab .tree-title.creative {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(244, 114, 182, 0.2));
            border: 1px solid var(--accent-purple);
        }
        #skills-tab .tree-title.corporate {
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.3), rgba(251, 191, 36, 0.2));
            border: 1px solid var(--accent-yellow);
        }
        #skills-tab .tier {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
            padding: 15px 10px;
            width: 100%;
        }
        #skills-tab .tier .icon-item {
            position: relative;
            width: 100px;
            margin-bottom: 10px;
        }
        #skills-tab .tier .icon-item .btn {
            width: 70px;
            height: 70px;
        }
        #skills-tab .connector-down::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 15px;
            background: var(--accent-blue);
            opacity: 0.6;
        }
        #skills-tab .tier-2::before,
        #skills-tab .tier-3::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            width: 80%;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--accent-blue) 20%, var(--accent-blue) 80%, transparent);
            opacity: 0.4;
        }
        #skills-tab .tier-2 .icon-item::before,
        #skills-tab .tier-3 .icon-item::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 15px;
            background: var(--accent-blue);
            opacity: 0.5;
        }
        #skills-tab .path-divider {
            width: 90%;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--glass-border), transparent);
            margin: 30px 0;
        }

        /* ===== Skill Popup ===== */
        #skill-popup {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border-top: 2px solid #3b82f6;
            padding: 20px;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            max-height: 50vh;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #skill-popup.active { bottom: 0; }
        #skill-popup .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #skill-popup .popup-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f8fafc;
        }
        #skill-popup .popup-close {
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        #skill-popup .popup-close:hover { color: #f8fafc; }
        #skill-popup .popup-content {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        #skill-popup .popup-info { flex: 1; }
        #skill-popup .popup-description {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        #skill-popup .popup-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.85rem;
        }
        #skill-popup .popup-buy-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 90px;
        }
        #skill-popup .popup-buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* ===== Tech Tier 1: Code Rabbit ===== */
        #skills-tab .btn-code-rabbit {
            background: #050a10;
            border: 1px solid var(--accent-cyan);
            overflow: hidden;
            position: relative;
        }
        #skills-tab .code-bg {
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(180deg, transparent 0, transparent 4px, rgba(34, 211, 238, 0.1) 4px, rgba(34, 211, 238, 0.1) 5px);
            animation: skills-scroll-code 3s linear infinite;
        }
        @keyframes skills-scroll-code {
            0% { background-position: 0 0; }
            100% { background-position: 0 20px; }
        }
        #skills-tab .rabbit-svg {
            width: 100%;
            height: 100%;
            fill: #e0e0e0;
            filter: drop-shadow(0 0 2px var(--accent-cyan));
        }
        #skills-tab .rabbit-eye {
            fill: var(--accent-cyan);
            filter: drop-shadow(0 0 5px var(--accent-cyan));
        }
        #skills-tab .speed-lines {
            stroke: rgba(34, 211, 238, 0.6);
            stroke-width: 2;
            stroke-dasharray: 10, 5;
        }

        /* ===== Tech Tier 2: Velocity Demon ===== */
        #skills-tab .btn-velocity-demon {
            background: linear-gradient(135deg, #450a0a, #7f1d1d);
            border: 1px solid var(--danger);
            overflow: hidden;
            animation: skills-vibrate 0.1s infinite;
        }
        @keyframes skills-vibrate {
            0% { transform: translate(0, 0); }
            25% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            75% { transform: translate(1px, -1px); }
            100% { transform: translate(-1px, 1px); }
        }
        #skills-tab .demon-blur {
            position: absolute;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 0, 0.5), rgba(255, 255, 0, 0.5));
            width: 100%;
            height: 100%;
            transform: skewX(-30deg);
            filter: blur(4px);
            opacity: 0.6;
        }
        #skills-tab .demon-svg {
            width: 100%;
            height: 100%;
            fill: #450a0a;
            stroke: var(--accent-yellow);
            stroke-width: 1;
        }
        #skills-tab .demon-eyes {
            fill: #fff;
            filter: drop-shadow(0 0 4px var(--danger));
        }
        #skills-tab .demon-grin {
            fill: none;
            stroke: #fff;
            stroke-width: 2;
        }

        /* ===== Tech Tier 2: Stack Overflow Scholar ===== */
        #skills-tab .btn-stackoverflow {
            background: #2d2d2d;
            border: 1px solid #f48024;
            box-shadow: 0 0 10px rgba(244, 128, 36, 0.2);
        }
        #skills-tab .book-browser-svg { width: 100%; height: 100%; }
        #skills-tab .browser-frame { fill: #fff; opacity: 0.1; }
        #skills-tab .book-spine { fill: #f48024; }
        #skills-tab .book-page { fill: #eee; }
        #skills-tab .sticky-note { fill: #ffeb3b; stroke: rgba(0, 0, 0, 0.1); }
        #skills-tab .cursor-pointer {
            fill: #fff;
            stroke: #000;
            stroke-width: 1;
            filter: drop-shadow(0 0 4px #f48024);
            animation: skills-bounce 2s infinite;
        }
        @keyframes skills-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* ===== Tech Tier 3: Caffeine Overdrive ===== */
        #skills-tab .btn-caffeine {
            background: #1a1a1a;
            border: 1px solid var(--success);
            overflow: hidden;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.2);
        }
        #skills-tab .mug-shake {
            animation: skills-vibrate-heavy 0.2s infinite;
            transform-origin: center bottom;
        }
        @keyframes skills-vibrate-heavy {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(2deg); }
            75% { transform: rotate(-2deg); }
        }
        #skills-tab .liquid-glow {
            fill: var(--success);
            filter: drop-shadow(0 0 5px var(--success));
        }
        #skills-tab .steam-jagged {
            stroke: #fff;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 100;
            animation: skills-dash 2s linear infinite;
        }
        @keyframes skills-dash { to { stroke-dashoffset: -200; } }

        /* ===== Tech Tier 3: Turbo Compiler ===== */
        #skills-tab .btn-turbo {
            background: #222;
            border: 1px solid #f43f5e;
            box-shadow: 0 0 10px rgba(244, 63, 94, 0.2);
        }
        #skills-tab .progress-frame { fill: #000; stroke: #555; stroke-width: 2; }
        #skills-tab .progress-fill { fill: #f43f5e; filter: drop-shadow(0 0 5px #f43f5e); }
        #skills-tab .sparks {
            fill: #ffff00;
            animation: skills-fly-sparks 0.5s linear infinite;
            opacity: 0;
        }
        @keyframes skills-fly-sparks {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(10px, -10px) scale(0); opacity: 0; }
        }

        /* ===== Tech Tier 3: Passive Income Bot ===== */
        #skills-tab .btn-passive-bot {
            background: #101520;
            border: 1px solid var(--accent-blue);
        }
        #skills-tab .bot-body { fill: var(--accent-blue); }
        #skills-tab .coin-drip {
            fill: var(--accent-yellow);
            animation: skills-drip 2s infinite;
        }
        @keyframes skills-drip {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(20px); opacity: 0; }
        }

        /* ===== Tech Tier 3: API Goldmine ===== */
        #skills-tab .btn-api-mine {
            background: #0a0a0a;
            border: 1px solid var(--accent-yellow);
        }
        #skills-tab .server-frame { fill: #222; stroke: #444; }
        #skills-tab .gold-core {
            fill: var(--accent-yellow);
            filter: drop-shadow(0 0 8px var(--accent-yellow));
            animation: skills-pulse-gold 2s infinite;
        }
        @keyframes skills-pulse-gold {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        #skills-tab .cable-vine {
            stroke: var(--accent-yellow);
            fill: none;
            stroke-width: 1.5;
        }

        /* ===== Creative Tier 1: Starving Artist ===== */
        #skills-tab .btn-starving-artist {
            background: #201a15;
            border: 1px solid #c2410c;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #skills-tab .cracked-frame {
            position: absolute;
            inset: 0;
            border: 1px dashed #553311;
            opacity: 0.5;
        }
        #skills-tab .paintbrush-taped {
            transform: rotate(-45deg);
            transform-origin: center;
            filter: drop-shadow(2px 2px 2px #000);
        }
        #skills-tab .brush-glow {
            fill: var(--accent-yellow);
            filter: blur(2px);
            opacity: 0.6;
            animation: skills-pulse-glow 2s infinite;
        }
        @keyframes skills-pulse-glow {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* ===== Creative Tier 2: Content Machine ===== */
        #skills-tab .btn-content-machine {
            background: #1a1a1a;
            border: 1px solid var(--text-secondary);
            overflow: hidden;
        }
        #skills-tab .conveyor-belt {
            fill: none;
            stroke: #444;
            stroke-width: 4;
            stroke-dasharray: 10, 5;
            animation: skills-conveyor-move 1s linear infinite;
        }
        @keyframes skills-conveyor-move { to { stroke-dashoffset: -15; } }

        /* ===== Creative Tier 2: Tank Artist ===== */
        #skills-tab .btn-tank-artist {
            background: #2a2a2a;
            border: 1px solid var(--success);
        }
        #skills-tab .palette-shield {
            fill: #8d6e63;
            stroke: #5d4037;
            stroke-width: 1;
        }
        #skills-tab .paint-splat {
            animation: skills-splat-pop 3s infinite;
        }
        @keyframes skills-splat-pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* ===== Creative Tier 3: Royalty Checks ===== */
        #skills-tab .btn-royalty-checks {
            background: #111;
            border: 1px solid var(--accent-yellow);
            border-radius: 50%;
        }
        #skills-tab .vinyl-record {
            transform-origin: 25px 25px;
            animation: skills-spin-slow 5s linear infinite;
        }
        @keyframes skills-spin-slow { to { transform: rotate(360deg); } }
        #skills-tab .orbiting-coin {
            fill: var(--accent-yellow);
            animation: skills-orbit-reverse 3s linear infinite;
            transform-origin: 25px 25px;
        }
        @keyframes skills-orbit-reverse {
            from { transform: rotate(360deg) translateX(18px) rotate(-360deg); }
            to { transform: rotate(0deg) translateX(18px) rotate(0deg); }
        }

        /* ===== Creative Tier 3: Set It Forget It ===== */
        #skills-tab .btn-set-forget {
            background: #222;
            border: 1px solid var(--text-secondary);
        }
        #skills-tab .toggle-switch-base { fill: #333; stroke: #555; }
        #skills-tab .toggle-switch-on { fill: var(--success); filter: drop-shadow(0 0 2px var(--success)); }
        #skills-tab .dust-layer { fill: #aaa; opacity: 0.3; }

        /* ===== Creative Tier 3: Fortress of Solitude ===== */
        #skills-tab .btn-fortress-solitude {
            background: #1e293b;
            border: 1px solid var(--text-secondary);
        }
        #skills-tab .concrete-walls { fill: #636e72; }
        #skills-tab .warm-window-light { fill: #fdcb6e; filter: drop-shadow(0 0 5px #fdcb6e); }

        /* ===== Creative Tier 3: Immovable Object ===== */
        #skills-tab .btn-immovable-object {
            background: #1e293b;
            border: 1px solid #cbd5e1;
        }
        #skills-tab .stone-block { fill: #636e72; stroke: #2d3436; }
        #skills-tab .impact-cracks { stroke: #b2bec3; fill: none; stroke-width: 0.5; }

        /* ===== Corporate Tier 1: Cubicle Warrior ===== */
        #skills-tab .btn-cubicle-warrior {
            background: #dcdde1;
            border: 1px solid var(--text-secondary);
        }
        #skills-tab .desk-shield { fill: #bdc3c7; stroke: var(--text-secondary); stroke-width: 1; }
        #skills-tab .keyboard-weapon { fill: #2c3e50; }

        /* ===== Corporate Tier 2: Promotion Chaser ===== */
        #skills-tab .btn-promo-chaser {
            background: #ecf0f1;
            border: 1px solid var(--accent-blue);
        }
        #skills-tab .staircase {
            fill: none;
            stroke: #95a5a6;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        #skills-tab .arrow-upward {
            fill: var(--accent-blue);
            animation: skills-climb-stairs 2s steps(4) infinite;
        }
        @keyframes skills-climb-stairs {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, -20px); }
        }

        /* ===== Corporate Tier 2: Benefits Maximizer ===== */
        #skills-tab .btn-benefits-max {
            background: #fff;
            border: 1px solid #27ae60;
        }
        #skills-tab .checklist-shield { fill: #fff; stroke: #27ae60; stroke-width: 1.5; }
        #skills-tab .check-mark { fill: #27ae60; }
        #skills-tab .med-cross { fill: var(--danger); }

        /* ===== Corporate Tier 3: Bonus Hunter ===== */
        #skills-tab .btn-bonus-hunter {
            background: #2c3e50;
            border: 1px solid var(--accent-yellow);
        }
        #skills-tab .target-ring { fill: none; stroke: #ecf0f1; stroke-width: 2; }
        #skills-tab .dollar-bullseye {
            fill: var(--accent-yellow);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 700;
            font-size: 14px;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        #skills-tab .arrow-pierce { stroke: var(--danger); stroke-width: 2; }

        /* ===== Corporate Tier 3: Executive Fast Track ===== */
        #skills-tab .btn-exec-fasttrack {
            background: #34495e;
            border: 1px solid var(--accent-blue);
            overflow: hidden;
        }
        #skills-tab .elevator-box { fill: #95a5a6; stroke: #7f8c8d; }
        #skills-tab .floor-numbers {
            fill: #ecf0f1;
            font-size: 10px;
            animation: skills-floor-blur 0.5s linear infinite;
        }
        @keyframes skills-floor-blur {
            from { transform: translateY(0); }
            to { transform: translateY(20px); }
        }

        /* ===== Corporate Tier 3: Corporate Fortress ===== */
        #skills-tab .btn-corp-fortress {
            background: #2c3e50;
            border: 1px solid #bdc3c7;
        }
        #skills-tab .skyscraper { fill: #34495e; stroke: #2c3e50; }
        #skills-tab .windows-lit { fill: var(--accent-yellow); }

        /* ===== Corporate Tier 3: Safety Net Supreme ===== */
        #skills-tab .btn-safety-net {
            background: #ecf0f1;
            border: 1px solid var(--warning);
        }
        #skills-tab .golden-net { stroke: var(--warning); stroke-width: 1; fill: none; }
        #skills-tab .figure-safe { fill: #2c3e50; }

        /* ===== Mobile Responsive ===== */
        @media (max-width: 600px) {
            #skills-tab .tier { gap: 10px; padding: 10px 5px; }
            #skills-tab .tier .icon-item { width: 80px; }
            #skills-tab .tier .icon-item .btn { width: 60px; height: 60px; }
            #skills-tab .tree-title { font-size: 1.2rem; padding: 8px 20px; }
            #skills-tab .icon-label { font-size: 0.7rem; }
        }

        /* ===== Too Expensive Grayed Out ===== */
        .too-expensive {
            opacity: 0.35;
            pointer-events: none;
            filter: grayscale(100%);
            cursor: not-allowed;
        }
        #skill-popup .popup-buy-btn.too-expensive {
            opacity: 0.35;
            pointer-events: none;
            filter: grayscale(100%);
            background: #666;
            box-shadow: none;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <canvas id="c"></canvas>
    <div id="game-overlay"></div>
    <div id="ui">
        <h1>DOOBERT</h1>
        <button id="playBtn">PLAY</button>
    </div>
    <div class="timer-display">15</div>

    <div id="shop-ui">
        <button id="closeShop">RESUME</button>
        <div id="shop-stats">
            <div class="stat-item">
                <span class="stat-label">üí∞ Balance:</span>
                <span id="shop-balance" class="stat-value">$0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">‚ù§Ô∏è Health:</span>
                <span id="shop-health" class="stat-value">100/100</span>
            </div>
        </div>
        <div id="skills-tab" class="tab-content active">
            <div class="skills-trees-container">
                <!-- Tech Path Binary Tree -->
                <div id="tech-tree" class="skill-tree" style="display: none;">
                    <div class="tree-title tech">‚ö° Tech Path</div>
                    <div class="tier tier-1">
                        <div class="icon-item connector-down">
                            <div class="btn btn-code-rabbit" title="Code Rabbit">
                                <div class="code-bg"></div>
                                <div class="rabbit-container">
                                    <svg class="rabbit-svg" viewBox="0 0 50 40">
                                        <line class="speed-lines" x1="0" y1="20" x2="15" y2="20" />
                                        <line class="speed-lines" x1="5" y1="25" x2="20" y2="25" />
                                        <path d="M15 25 Q 25 20, 35 25 L 45 20 Q 48 15, 35 15 Q 25 10, 15 25 Z" />
                                        <circle cx="42" cy="18" r="6" />
                                        <circle class="rabbit-eye" cx="44" cy="16" r="1.5" />
                                    </svg>
                                </div>
                            </div>
                            <div class="icon-label">Code Rabbit</div>
                        </div>
                    </div>
                    <div class="tier tier-2">
                        <div class="icon-item">
                            <div class="btn btn-velocity-demon" title="Velocity Demon">
                                <div class="demon-blur"></div>
                                <svg class="demon-svg" viewBox="0 0 50 50">
                                    <path d="M15 40 L 25 25 L 35 20 Q 45 15, 40 10 L 35 5 Q 30 10, 25 10 L 10 30 Z" transform="rotate(15 25 25)" />
                                    <path d="M35 5 L 32 -5 L 38 0 Z" fill="var(--danger)" />
                                    <path d="M40 10 L 45 0 L 42 5 Z" fill="var(--danger)" />
                                    <circle class="demon-eyes" cx="35" cy="12" r="2" />
                                    <path class="demon-grin" d="M32 18 Q 36 20, 40 16" />
                                </svg>
                            </div>
                            <div class="icon-label">Velocity Demon</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-stackoverflow" title="Stack Overflow Scholar">
                                <svg class="book-browser-svg" viewBox="0 0 60 50">
                                    <rect class="browser-frame" x="5" y="5" width="50" height="40" rx="2" />
                                    <rect x="5" y="5" width="50" height="10" fill="#444" rx="2" />
                                    <circle cx="10" cy="10" r="2" fill="#ff5f56" />
                                    <circle cx="16" cy="10" r="2" fill="#ffbd2e" />
                                    <circle cx="22" cy="10" r="2" fill="#27c93f" />
                                    <path class="book-page" d="M10 20 Q 20 20, 30 25 Q 40 20, 50 20 L 50 40 Q 40 40, 30 45 Q 20 40, 10 40 Z" />
                                    <path class="book-spine" d="M29 25 L 31 25 L 31 45 L 29 45 Z" />
                                    <rect class="sticky-note" x="42" y="15" width="6" height="8" rx="1" transform="rotate(10 45 19)" />
                                    <rect class="sticky-note" x="48" y="28" width="6" height="8" rx="1" transform="rotate(-5 51 32)" />
                                    <path class="cursor-pointer" d="M35 15 L 42 22 L 35 29 Z" transform="rotate(-90 35 15) translate(5, 5)" />
                                </svg>
                            </div>
                            <div class="icon-label">Stack Overflow</div>
                        </div>
                    </div>
                    <div class="tier tier-3">
                        <div class="icon-item">
                            <div class="btn btn-caffeine" title="Caffeine Overdrive">
                                <svg class="mug-shake" viewBox="0 0 50 50">
                                    <path d="M10 10 L 12 40 Q 12 45, 17 45 L 33 45 Q 38 45, 38 40 L 40 10" fill="none" stroke="var(--text-secondary)" stroke-width="3" />
                                    <path d="M40 15 Q 48 15, 48 25 Q 48 35, 40 35" fill="none" stroke="var(--text-secondary)" stroke-width="3" />
                                    <path class="liquid-glow" d="M12 25 L 13 40 Q 13 43, 17 43 L 33 43 Q 37 43, 37 40 L 38 25 Q 25 30, 12 25 Z" />
                                    <path class="steam-jagged" d="M15 5 L 20 10 L 15 15 M 25 2 L 30 8 L 25 14 M 35 5 L 40 10 L 35 15" />
                                    <path d="M20 20 L 25 30 L 30 15" fill="none" stroke="#fff" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="icon-label">Caffeine OD</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-turbo" title="Turbo Compiler">
                                <svg viewBox="0 0 60 40">
                                    <rect class="progress-frame" x="2" y="15" width="56" height="10" rx="2" transform="rotate(-2 30 20)" />
                                    <rect class="progress-fill" x="4" y="17" width="52" height="6" rx="1" transform="rotate(-2 30 20)" />
                                    <circle class="sparks" cx="55" cy="15" r="1.5" style="animation-duration: 0.4s; animation-delay: 0s;" />
                                    <circle class="sparks" cx="57" cy="20" r="1" style="animation-duration: 0.6s; animation-delay: 0.1s;" />
                                    <circle class="sparks" cx="53" cy="18" r="2" style="animation-duration: 0.5s; animation-delay: 0.2s;" />
                                </svg>
                            </div>
                            <div class="icon-label">Turbo Compiler</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-passive-bot" title="Passive Income Bot">
                                <svg viewBox="0 0 50 50">
                                    <rect class="bot-body" x="15" y="10" width="20" height="25" rx="2" />
                                    <circle class="bot-body" cx="25" cy="-5" r="8" />
                                    <line x1="15" y1="20" x2="5" y2="25" stroke="var(--accent-blue)" stroke-width="3" />
                                    <line x1="35" y1="20" x2="45" y2="15" stroke="var(--accent-blue)" stroke-width="3" />
                                    <rect x="22" y="15" width="6" height="2" fill="#000" />
                                    <circle class="coin-drip" cx="25" cy="18" r="2" />
                                    <circle class="coin-drip" cx="25" cy="25" r="2" style="animation-delay: 0.5s;" />
                                </svg>
                            </div>
                            <div class="icon-label">Income Bot</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-api-mine" title="API Goldmine">
                                <svg viewBox="0 0 50 60">
                                    <rect class="server-frame" x="5" y="5" width="40" height="50" rx="3" />
                                    <path class="gold-core" d="M15 20 L 25 15 L 35 20 L 30 35 L 20 35 Z" />
                                    <path class="cable-vine" d="M25 35 Q 25 45, 10 50" />
                                    <path class="cable-vine" d="M25 35 Q 25 45, 40 50" />
                                    <circle cx="10" cy="50" r="2" fill="#ffd700" />
                                    <circle cx="40" cy="50" r="2" fill="#ffd700" />
                                </svg>
                            </div>
                            <div class="icon-label">API Goldmine</div>
                        </div>
                    </div>
                </div>

                <!-- Creative Path Binary Tree -->
                <div id="creative-tree" class="skill-tree" style="display: none;">
                    <div class="tree-title creative">üé® Creative Path</div>
                    <div class="tier tier-1">
                        <div class="icon-item connector-down">
                            <div class="btn btn-starving-artist" title="Starving Artist">
                                <div class="cracked-frame"></div>
                                <svg viewBox="0 0 50 50">
                                    <rect class="paintbrush-taped" x="22" y="15" width="6" height="20" fill="#a0522d" rx="1" />
                                    <rect class="paintbrush-taped" x="21" y="22" width="8" height="4" fill="#ddd" rx="0.5" />
                                    <path class="paintbrush-taped" d="M22 15 L 20 5 L 30 5 L 28 15 Z" fill="#d3d3d3" />
                                    <circle class="brush-glow" cx="25" cy="5" r="3" />
                                </svg>
                            </div>
                            <div class="icon-label">Starving Artist</div>
                        </div>
                    </div>
                    <div class="tier tier-2">
                        <div class="icon-item">
                            <div class="btn btn-content-machine" title="Content Machine">
                                <svg viewBox="0 0 50 50">
                                    <path class="conveyor-belt" d="M5 35 L 45 35" />
                                    <rect x="10" y="25" width="8" height="10" fill="#ef5350" />
                                    <circle cx="25" cy="30" r="4" fill="#42a5f5" />
                                    <rect x="35" y="25" width="8" height="10" fill="#ffca28" />
                                    <circle cx="10" cy="38" r="3" fill="#666" />
                                    <circle cx="25" cy="38" r="3" fill="#666" />
                                    <circle cx="40" cy="38" r="3" fill="#666" />
                                </svg>
                            </div>
                            <div class="icon-label">Content Machine</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-tank-artist" title="Tank Artist">
                                <svg viewBox="0 0 50 50">
                                    <path class="palette-shield" d="M10 25 Q 10 5, 25 5 Q 40 5, 40 25 Q 40 45, 25 45 Q 10 45, 10 25 Z" />
                                    <circle cx="18" cy="20" r="3" fill="#2a2a2a" />
                                    <circle class="paint-splat" cx="30" cy="15" r="3" fill="#f44336" style="animation-delay: 0s;" />
                                    <circle class="paint-splat" cx="35" cy="25" r="3" fill="#2196f3" style="animation-delay: 0.5s;" />
                                    <circle class="paint-splat" cx="28" cy="35" r="3" fill="#ffeb3b" style="animation-delay: 1s;" />
                                    <line x1="15" y1="30" x2="20" y2="35" stroke="#5d4037" stroke-width="1" />
                                </svg>
                            </div>
                            <div class="icon-label">Tank Artist</div>
                        </div>
                    </div>
                    <div class="tier tier-3">
                        <div class="icon-item">
                            <div class="btn btn-royalty-checks" title="Royalty Checks">
                                <svg viewBox="0 0 50 50">
                                    <circle class="vinyl-record" cx="25" cy="25" r="20" fill="#111" stroke="#333" stroke-width="1" />
                                    <circle class="vinyl-record" cx="25" cy="25" r="8" fill="#e91e63" />
                                    <circle cx="25" cy="25" r="2" fill="#000" />
                                    <circle class="orbiting-coin" cx="25" cy="25" r="3" />
                                </svg>
                            </div>
                            <div class="icon-label">Royalty Checks</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-set-forget" title="Set It Forget It">
                                <svg viewBox="0 0 50 50">
                                    <rect class="toggle-switch-base" x="10" y="15" width="30" height="20" rx="10" />
                                    <circle class="toggle-switch-on" cx="32" cy="25" r="8" />
                                    <path class="dust-layer" d="M10 15 Q 25 20, 40 15 L 40 20 Q 25 25, 10 20 Z" />
                                </svg>
                            </div>
                            <div class="icon-label">Set & Forget</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-fortress-solitude" title="Fortress of Solitude">
                                <svg viewBox="0 0 50 50">
                                    <rect class="concrete-walls" x="10" y="15" width="30" height="25" />
                                    <rect class="warm-window-light" x="22" y="20" width="6" height="8" />
                                    <path class="concrete-walls" d="M5 15 L 25 5 L 45 15 Z" />
                                </svg>
                            </div>
                            <div class="icon-label">Fortress</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-immovable-object" title="Immovable Object">
                                <svg viewBox="0 0 50 50">
                                    <line x1="0" y1="40" x2="50" y2="40" stroke="#7f8c8d" stroke-width="2" />
                                    <rect class="stone-block" x="15" y="20" width="20" height="25" />
                                    <path class="impact-cracks" d="M10 40 L 15 35 M 40 40 L 35 35 M 25 20 L 25 10" />
                                </svg>
                            </div>
                            <div class="icon-label">Immovable</div>
                        </div>
                    </div>
                </div>

                <!-- Corporate Path Binary Tree -->
                <div id="corporate-tree" class="skill-tree" style="display: none;">
                    <div class="tree-title corporate">üíº Corporate Path</div>
                    <div class="tier tier-1">
                        <div class="icon-item connector-down">
                            <div class="btn btn-cubicle-warrior" title="Cubicle Warrior">
                                <svg viewBox="0 0 50 50">
                                    <path class="desk-shield" d="M10 20 L 40 20 L 40 40 L 10 40 Z" />
                                    <rect x="15" y="25" width="20" height="10" fill="#ecf0f1" />
                                    <rect class="keyboard-weapon" x="12" y="30" width="26" height="8" rx="1" />
                                </svg>
                            </div>
                            <div class="icon-label">Cubicle Warrior</div>
                        </div>
                    </div>
                    <div class="tier tier-2">
                        <div class="icon-item">
                            <div class="btn btn-promo-chaser" title="Promotion Chaser">
                                <svg viewBox="0 0 50 50">
                                    <path class="staircase" d="M10 40 L 20 40 L 20 30 L 30 30 L 30 20 L 40 20 L 40 10" />
                                    <path class="arrow-upward" d="M15 40 L 15 30 L 10 35 M 15 30 L 20 35" stroke="#3498db" stroke-width="2" />
                                    <text x="12" y="38" font-size="6" fill="#7f8c8d">Jr</text>
                                    <text x="32" y="18" font-size="6" fill="#7f8c8d">CEO</text>
                                </svg>
                            </div>
                            <div class="icon-label">Promo Chaser</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-benefits-max" title="Benefits Maximizer">
                                <svg viewBox="0 0 50 50">
                                    <rect class="checklist-shield" x="15" y="10" width="20" height="30" rx="2" />
                                    <path class="check-mark" d="M20 18 L 23 21 L 28 16" fill="none" stroke="#27ae60" stroke-width="2" />
                                    <path class="check-mark" d="M20 25 L 23 28 L 28 23" fill="none" stroke="#27ae60" stroke-width="2" />
                                    <path class="check-mark" d="M20 32 L 23 35 L 28 30" fill="none" stroke="#27ae60" stroke-width="2" />
                                    <rect x="30" y="32" width="6" height="6" fill="#e74c3c" />
                                    <path d="M33 33 L 33 37 M 31 35 L 35 35" stroke="#fff" stroke-width="1.5" />
                                </svg>
                            </div>
                            <div class="icon-label">Benefits Max</div>
                        </div>
                    </div>
                    <div class="tier tier-3">
                        <div class="icon-item">
                            <div class="btn btn-bonus-hunter" title="Bonus Hunter">
                                <svg viewBox="0 0 50 50">
                                    <circle class="target-ring" cx="25" cy="25" r="15" />
                                    <circle class="target-ring" cx="25" cy="25" r="10" />
                                    <text class="dollar-bullseye" x="25" y="26">$</text>
                                    <line class="arrow-pierce" x1="40" y1="10" x2="25" y2="25" />
                                </svg>
                            </div>
                            <div class="icon-label">Bonus Hunter</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-exec-fasttrack" title="Executive Fast Track">
                                <svg viewBox="0 0 50 50">
                                    <rect class="elevator-box" x="15" y="10" width="20" height="30" />
                                    <line x1="25" y1="10" x2="25" y2="40" stroke="#7f8c8d" stroke-width="1" />
                                    <g class="floor-numbers">
                                        <text x="38" y="15">10</text>
                                        <text x="38" y="25">20</text>
                                        <text x="38" y="35">30</text>
                                        <text x="38" y="5">5</text>
                                    </g>
                                    <path d="M25 5 L 20 10 L 30 10 Z" fill="#2ecc71" />
                                </svg>
                            </div>
                            <div class="icon-label">Fast Track</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-corp-fortress" title="Corporate Fortress">
                                <svg viewBox="0 0 50 50">
                                    <rect class="skyscraper" x="15" y="5" width="20" height="40" />
                                    <rect class="skyscraper" x="10" y="20" width="5" height="25" />
                                    <rect class="skyscraper" x="35" y="15" width="5" height="30" />
                                    <rect class="windows-lit" x="17" y="10" width="2" height="2" />
                                    <rect class="windows-lit" x="21" y="10" width="2" height="2" />
                                    <rect class="windows-lit" x="25" y="10" width="2" height="2" />
                                    <rect class="windows-lit" x="29" y="10" width="2" height="2" />
                                    <rect class="windows-lit" x="17" y="15" width="2" height="2" />
                                    <rect class="windows-lit" x="29" y="30" width="2" height="2" />
                                </svg>
                            </div>
                            <div class="icon-label">Corp Fortress</div>
                        </div>
                        <div class="icon-item">
                            <div class="btn btn-safety-net" title="Safety Net Supreme">
                                <svg viewBox="0 0 50 50">
                                    <path class="golden-net" d="M5 35 Q 25 45, 45 35" />
                                    <line class="golden-net" x1="10" y1="36" x2="15" y2="40" />
                                    <line class="golden-net" x1="20" y1="39" x2="25" y2="40" />
                                    <line class="golden-net" x1="30" y1="39" x2="35" y2="38" />
                                    <circle class="figure-safe" cx="25" cy="30" r="3" />
                                    <line x1="25" y1="33" x2="25" y2="40" stroke="#2c3e50" stroke-width="2" />
                                </svg>
                            </div>
                            <div class="icon-label">Safety Net</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Skill Popup -->
            <div id="skill-popup">
                <div class="popup-header">
                    <div class="popup-title" id="popup-skill-name">Skill Name</div>
                    <button class="popup-close" onclick="closeSkillPopup()">&times;</button>
                </div>
                <div class="popup-content">
                    <div class="popup-info">
                        <div class="popup-description" id="popup-description">Skill description goes here</div>
                        <div class="popup-stats" id="popup-stats">
                            <!-- Stats will be injected here -->
                        </div>
                    </div>
                    <button class="popup-buy-btn" id="popup-buy-btn" onclick="buySkill()">
                        Buy - $<span id="popup-price">0</span>
                    </button>
                </div>
            </div>
        </div>
        <div id="shop-tab" class="tab-content">
            <h1>Health Shop</h1>
            <div class="shop-container">
                <!-- 1. Food: Apple -->
                <div class="shop-item item-food" onclick="buyItem('Fresh Apple', 500, 5)">
                    <span class="item-icon">üçé</span>
                    <span class="item-title">Fresh Apple</span>
                    <span class="item-cost">$500</span>
                    <span class="item-health">+5 HP</span>
                </div>

                <!-- 2. Wellness: Vitamins -->
                <div class="shop-item item-med" onclick="buyItem('Vitamins', 1250, 10)">
                    <span class="item-icon">üíä</span>
                    <span class="item-title">Vitamins</span>
                    <span class="item-cost">$1250</span>
                    <span class="item-health">+10 HP</span>
                </div>

                <!-- 3. Exercise: Gym Pass -->
                <div class="shop-item item-mental" onclick="buyItem('Gym Pass', 3750, 40)">
                    <span class="item-icon">üí™</span>
                    <span class="item-title">Gym Pass</span>
                    <span class="item-cost">$3750</span>
                    <span class="item-health">+40 HP</span>
                </div>

                <!-- 4. Medicine: First Aid -->
                <div class="shop-item item-med" onclick="buyItem('First Aid Kit', 2500, 25)">
                    <span class="item-icon">ü©π</span>
                    <span class="item-title">First Aid Kit</span>
                    <span class="item-cost">$2500</span>
                    <span class="item-health">+25 HP</span>
                </div>

                <!-- 5. Mental Health: Therapy -->
                <div class="shop-item item-mental" onclick="buyItem('Therapy', 5000, 50)">
                    <span class="item-icon">üß†</span>
                    <span class="item-title">Therapy</span>
                    <span class="item-cost">$5000</span>
                    <span class="item-health">+50 HP</span>
                </div>

                <!-- 6. Rest: Luxury Spa -->
                <div class="shop-item item-rest" onclick="buyItem('Luxury Spa', 25000, 100)">
                    <span class="item-icon">üßñ‚Äç‚ôÄÔ∏è</span>
                    <span class="item-title">Luxury Spa</span>
                    <span class="item-cost">$25000</span>
                    <span class="item-health">FULL HP</span>
                </div>
            </div>
            <div id="status-msg"></div>
        </div>
        <div id="cards-tab" class="tab-content">
            <div class="cards-container">
                <h1 class="cards-title">üí∞ Financial Crossroads</h1>
                <div class="card-container" id="cardContainer">
                    <!-- Decision card will be rendered here -->
                </div>
            </div>
        </div>
        <div class="nav-bar">
            <button class="nav-tab active" data-tab="skills">SKILLS</button>
            <button class="nav-tab" data-tab="shop">SHOP</button>
        </div>
    </div>

    <canvas id="sky-canvas" class="layer"></canvas>
    <canvas id="stars-canvas" class="layer"></canvas>
    <canvas id="aurora-canvas" class="layer"></canvas>

    <!-- Water Base -->
    <div id="water-base"></div>
    <!-- City sits above water -->
    <canvas id="city-canvas" class="layer"></canvas>
    <!-- Reflection is a copy of city/lights inverted -->
    <canvas id="reflection-canvas"></canvas>

    <!-- Character selection -->
    <div id="character-selection">
        <svg width="0" height="0">
            <defs>
                <linearGradient id="tartanGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#cc0000" />
                    <stop offset="25%" stop-color="#006600" />
                    <stop offset="50%" stop-color="#000066" />
                    <stop offset="75%" stop-color="#ffff00" />
                    <stop offset="100%" stop-color="#cc0000" />
                </linearGradient>
                <linearGradient id="lensGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#00f3ff" />
                    <stop offset="100%" stop-color="#d400ff" />
                </linearGradient>
            </defs>
        </svg>

        <h2>Character Selection</h2>
        <div class="container char-body">
            <!-- Scotty -->
            <div class="char-card">
                <div class="char-btn btn-scotty" title="Scotty" onclick="selectCharacter('scotty')">
                    <div class="scotty-bg"></div>
                    <svg class="scotty-svg" viewBox="0 0 100 100">
                        <!-- Body -->
                        <ellipse cx="50" cy="65" rx="22" ry="18" class="terrier-body" />

                        <!-- Legs -->
                        <rect x="30" y="75" width="12" height="15" fill="#0d0d0d" stroke="#333" stroke-width="2"
                            rx="6" />
                        <rect x="60" y="75" width="12" height="15" fill="#0d0d0d" stroke="#333" stroke-width="2"
                            rx="6" />

                        <!-- Tartan Bandana -->
                        <path d="M30 50 L 70 50 L 50 78 Z" fill="url(#tartanPattern)" stroke="#000" stroke-width="1" />

                        <!-- Head (black, shaggy) -->
                        <ellipse cx="50" cy="42" rx="20" ry="22" class="terrier-head" />

                        <!-- Pointed Ears -->
                        <path d="M35 30 L 32 15 L 40 28 Z" class="terrier-head" />
                        <path d="M65 30 L 68 15 L 60 28 Z" class="terrier-head" />
                        <path d="M36 28 L 34 20 L 39 28 Z" class="ear-highlight" />
                        <path d="M64 28 L 66 20 L 61 28 Z" class="ear-highlight" />

                        <!-- Shaggy fur texture -->
                        <path d="M32 38 Q 28 42, 30 46" class="shaggy-fur" />
                        <path d="M68 38 Q 72 42, 70 46" class="shaggy-fur" />
                        <path d="M35 50 Q 32 54, 34 58" class="shaggy-fur" />
                        <path d="M65 50 Q 68 54, 66 58" class="shaggy-fur" />

                        <!-- Distinctive Beard -->
                        <ellipse cx="50" cy="56" rx="14" ry="10" class="scotty-beard" />
                        <path d="M40 58 Q 38 62, 40 64" class="shaggy-fur" />
                        <path d="M60 58 Q 62 62, 60 64" class="shaggy-fur" />

                        <!-- Snout -->
                        <ellipse cx="50" cy="52" rx="8" ry="6" class="scotty-snout" />

                        <!-- Eyes -->
                        <circle cx="43" cy="42" r="3" class="scotty-eye" />
                        <circle cx="57" cy="42" r="3" class="scotty-eye" />
                        <circle cx="43" cy="42" r="1.5" fill="#fff" />
                        <circle cx="57" cy="42" r="1.5" fill="#fff" />

                        <!-- Nose -->
                        <ellipse cx="50" cy="52" rx="3" ry="2.5" fill="#000" />
                    </svg>
                </div>
                <div class="char-name">Scotty</div>
                <div class="char-desc">Thrifty, Steady, Risk-Averse</div>
                <div class="char-stats">
                    <div class="stat-row"><span class="stat-label">üí∞ Income</span><span class="stat-value">95%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üõ°Ô∏è Defense</span><span
                            class="stat-value">130%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üìä Passive Income</span><span
                            class="stat-value">120%</span></div>
                    <div class="special-ability">
                        <div class="ability-name">SCOTTISH SAVINGS</div>
                        <div class="ability-desc">‚Ä¢ Auto-banks 10% of year-end balance<br>‚Ä¢ Locked for 2 years, +15%
                            passive
                            income<br>‚Ä¢ Early withdrawal burns 20%</div>
                    </div>
                </div>
            </div>

            <!-- Husky -->
            <div class="char-card">
                <div class="char-btn btn-husky" title="Husky" onclick="selectCharacter('husky')">
                    <svg class="husky-svg" viewBox="0 0 100 100">
                        <path class="husky-fur"
                            d="M20 40 L 30 10 L 40 30 L 60 30 L 70 10 L 80 40 L 85 70 Q 50 85, 15 70 Z" />
                        <path class="husky-mask" d="M20 40 L 40 30 L 50 50 L 60 30 L 80 40 L 75 60 Q 50 70, 25 60 Z" />
                        <path class="husky-fur" d="M40 30 L 50 50 L 60 30" /> <!-- Forehead blaze -->
                        <!-- Sunglasses -->
                        <path class="glasses-frame" d="M25 45 H 75 V 55 H 25 Z" />
                        <rect class="glasses-lens" x="27" y="47" width="20" height="6" />
                        <rect class="glasses-lens" x="53" y="47" width="20" height="6" />
                        <path d="M50 48 L 50 45" stroke="#111" stroke-width="2" /> <!-- Bridge -->
                        <path class="crypto-glint" d="M30 47 L 35 47 L 32 53 Z" /> <!-- Glint -->
                        <!-- Snout -->
                        <ellipse cx="50" cy="58" rx="10" ry="8" fill="#e0e0e0" /> <!-- Muzzle base -->
                        <path d="M42 55 Q 50 52, 58 55" fill="none" stroke="#ddd" stroke-width="1" />
                        <ellipse cx="50" cy="54" rx="4" ry="3" fill="#111" /> <!-- Nose -->
                        <!-- Confident Smirk -->
                        <path d="M45 62 Q 50 64, 55 61" fill="none" stroke="#111" stroke-width="1.5" />
                    </svg>
                </div>
                <div class="char-name">Husky</div>
                <div class="char-desc">High Risk, Crypto Bro Energy</div>
                <div class="char-stats">
                    <div class="stat-row"><span class="stat-label">üí∞ Income</span><span class="stat-value">140%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üõ°Ô∏è Defense</span><span class="stat-value">65%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üìä Passive Income</span><span
                            class="stat-value">75%</span></div>
                    <div class="special-ability">
                        <div class="ability-name">MOON SHOT</div>
                        <div class="ability-desc">‚Ä¢ Coin value: $65‚Äì$160 (volatile)<br>‚Ä¢ Boom: +2√ó coin value<br>‚Ä¢
                            Crash:
                            ‚àí30% year-end balance<br>‚Ä¢ Consecutive crashes stack</div>
                    </div>
                </div>
            </div>

            <!-- Golden -->
            <div class="char-card">
                <div class="char-btn btn-golden" title="Golden Retriever" onclick="selectCharacter('golden')">
                    <svg class="golden-svg" viewBox="0 0 100 120">
                        <!-- Tail (Wagging) -->
                        <path d="M65 95 Q 80 85, 75 75" stroke="#d4af37" stroke-width="6" fill="none"
                            stroke-linecap="round">
                            <animate attributeName="d"
                                values="M65 95 Q 80 85, 75 75; M65 95 Q 80 105, 85 95; M65 95 Q 80 85, 75 75" dur="1s"
                                repeatCount="indefinite" />
                        </path>

                        <!-- Body (Sitting) -->
                        <path d="M30 110 L 40 60 Q 50 50, 60 60 L 70 110 Z" class="golden-fur" />

                        <!-- Paws -->
                        <ellipse cx="35" cy="110" rx="8" ry="5" class="golden-fur" />
                        <ellipse cx="65" cy="110" rx="8" ry="5" class="golden-fur" />
                        <ellipse cx="40" cy="100" rx="6" ry="10" class="golden-fur" />
                        <ellipse cx="60" cy="100" rx="6" ry="10" class="golden-fur" />

                        <!-- Head -->
                        <g transform="translate(0, 10)">
                            <ellipse cx="50" cy="45" rx="22" ry="25" class="golden-fur" />
                            <!-- Ears -->
                            <ellipse cx="30" cy="40" rx="8" ry="15" class="golden-fur" />
                            <ellipse cx="70" cy="40" rx="8" ry="15" class="golden-fur" />
                            <!-- Snout/Face -->
                            <ellipse cx="50" cy="55" rx="12" ry="10" class="golden-snoot" />
                            <circle cx="42" cy="42" r="3" fill="#000" />
                            <circle cx="58" cy="42" r="3" fill="#000" />
                            <circle cx="50" cy="55" r="3" fill="#000" />
                            <!-- Glasses -->
                            <circle class="glass-lens-clear" cx="42" cy="42" r="6" stroke="#000" stroke-width="1.5"
                                fill="rgba(255,255,255,0.2)" />
                            <circle class="glass-lens-clear" cx="58" cy="42" r="6" stroke="#000" stroke-width="1.5"
                                fill="rgba(255,255,255,0.2)" />
                            <line x1="48" y1="42" x2="52" y2="42" stroke="#000" stroke-width="1.5" />
                        </g>
                    </svg>
                </div>
                <div class="char-name">Golden Retriever</div>
                <div class="char-desc">Patient, Compound Interest</div>
                <div class="char-stats">
                    <div class="stat-row"><span class="stat-label">üí∞ Income</span><span class="stat-value">75%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üõ°Ô∏è Defense</span><span class="stat-value">95%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üìä Passive Income</span><span
                            class="stat-value">165%</span></div>
                    <div class="special-ability">
                        <div class="ability-name">COMPOUND MAGIC</div>
                        <div class="ability-desc">‚Ä¢ Year-end balance +10% growth<br>‚Ä¢ Passive skills unlock 1 year
                            early<br>‚Ä¢ 70% balance locked each year</div>
                    </div>
                </div>
            </div>

            <!-- Corgi -->
            <div class="char-card">
                <div class="char-btn btn-corgi" title="Corgi" onclick="selectCharacter('corgi')">
                    <svg class="corgi-svg" viewBox="0 0 100 120">
                        <!-- Cape -->
                        <path d="M30 60 L 70 60 L 80 110 L 20 110 Z" fill="#990000" stroke="#ffd700" stroke-width="1" />

                        <!-- Tail (Nub) -->
                        <ellipse cx="73" cy="80" rx="3" ry="5" class="corgi-fur-orange" transform="rotate(-20 73 80)" />

                        <!-- Body (Long) -->
                        <rect x="25" y="70" width="50" height="30" rx="10" class="corgi-fur-orange" />
                        <rect x="35" y="70" width="30" height="30" rx="10" class="corgi-fur-white" opacity="0.5" />

                        <!-- Stubby Legs -->
                        <rect x="25" y="95" width="8" height="15" rx="3" class="corgi-fur-orange" />
                        <rect x="67" y="95" width="8" height="15" rx="3" class="corgi-fur-orange" />

                        <!-- Head -->
                        <g transform="translate(0, 15)">
                            <ellipse cx="50" cy="50" rx="20" ry="22" class="corgi-fur-orange" />
                            <ellipse cx="35" cy="35" rx="7" ry="12" class="corgi-fur-orange" />
                            <ellipse cx="65" cy="35" rx="7" ry="12" class="corgi-fur-orange" />
                            <ellipse cx="50" cy="50" rx="8" ry="15" class="corgi-fur-white" />
                            <circle cx="42" cy="47" r="3" fill="#000" />
                            <circle cx="58" cy="47" r="3" fill="#000" />
                            <circle cx="50" cy="58" r="3" fill="#000" />
                            <!-- Smile -->
                            <path d="M45 62 Q 50 65, 55 62" fill="none" stroke="#000" stroke-width="1.5" />
                            <!-- Crown -->
                            <g class="crown">
                                <path d="M35 28 L 38 20 L 43 25 L 50 18 L 57 25 L 62 20 L 65 28 L 35 28 Z" />
                                <circle class="gem" cx="50" cy="24" r="2" />
                            </g>
                        </g>
                    </svg>
                </div>
                <div class="char-name">Corgi</div>
                <div class="char-desc">Royalty, Born with Advantages</div>
                <div class="char-stats">
                    <div class="stat-row"><span class="stat-label">üí∞ Income</span><span class="stat-value">120%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üõ°Ô∏è Defense</span><span
                            class="stat-value">110%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üìä Passive Income</span><span
                            class="stat-value">135%</span></div>
                    <div class="special-ability">
                        <div class="ability-name">INHERITANCE</div>
                        <div class="ability-desc">‚Ä¢ Starts Year 1 with 500 coins ($50K)<br>‚Ä¢ Random windfalls (+100‚Äì300
                            coins)<br>‚Ä¢ Skill costs +15% yearly<br>‚Ä¢ Lifestyle siphons 5% balance yearly</div>
                    </div>
                </div>
            </div>

            <!-- Shiba Inu -->
            <div class="char-card">
                <div class="char-btn btn-shiba" title="Shiba Inu" onclick="selectCharacter('shiba')">
                    <div class="safety-shield-aura"></div>
                    <svg class="shiba-svg" viewBox="0 0 100 120">
                        <!-- Curled Tail - Moved Closer & Down -->
                        <path d="M72 85 Q 85 75, 80 65" stroke="#d4834f" stroke-width="6" fill="none"
                            stroke-linecap="round" />

                        <!-- Body -->
                        <rect x="30" y="60" width="40" height="40" rx="10" class="fur-orange" />
                        <rect x="35" y="65" width="30" height="30" rx="8" class="fur-cream" opacity="0.6" />

                        <!-- Legs -->
                        <rect x="32" y="90" width="8" height="20" rx="3" class="fur-orange" />
                        <rect x="60" y="90" width="8" height="20" rx="3" class="fur-orange" />

                        <!-- Head -->
                        <g transform="translate(0, 10)">
                            <ellipse cx="50" cy="50" rx="22" ry="24" class="fur-orange" />
                            <!-- Ears -->
                            <path d="M35 35 L 30 20 L 40 30 Z" class="fur-orange" />
                            <path d="M65 35 L 70 20 L 60 30 Z" class="fur-orange" />
                            <path d="M35 32 L 32 22 L 38 30 Z" class="fur-cream" />
                            <path d="M65 32 L 68 22 L 62 30 Z" class="fur-cream" />
                            <!-- Face -->
                            <ellipse cx="50" cy="58" rx="14" ry="10" class="fur-cream" />
                            <ellipse cx="42" cy="48" rx="3" ry="4" fill="#000" />
                            <ellipse cx="58" cy="48" rx="3" ry="4" fill="#000" />
                            <circle cx="50" cy="60" r="3" fill="#000" />
                            <path d="M42 64 Q 50 68, 58 64" fill="none" stroke="#000" stroke-width="1.5" />
                            <!-- Helmet -->
                            <ellipse cx="50" cy="28" rx="18" ry="10" class="helmet-yellow" />
                            <rect x="32" y="34" width="36" height="4" class="helmet-yellow" rx="2" />
                        </g>
                    </svg>
                </div>
                <div class="char-name">Shiba Inu</div>
                <div class="char-desc">Cautious, Emergency Fund</div>
                <div class="char-stats">
                    <div class="stat-row"><span class="stat-label">üí∞ Income</span><span class="stat-value">85%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üõ°Ô∏è Defense</span><span
                            class="stat-value">150%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üìä Passive Income</span><span
                            class="stat-value">95%</span></div>
                    <div class="special-ability">
                        <div class="ability-name">SELF-PRESERVATION INSTINCT</div>
                        <div class="ability-desc">‚Ä¢ Starts with 3 Guard Tokens yearly<br>‚Ä¢ Tokens negate
                            obstacles/events<br>‚Ä¢ Debt/penalties reduced 40%<br>‚Ä¢ Skill costs +10%, no high-risk bonuses
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pitbull -->
            <div class="char-card">
                <div class="char-btn btn-pitbull" title="Pitbull" onclick="selectCharacter('pitbull')">
                    <svg class="pitbull-svg" viewBox="0 0 100 120">
                        <!-- Body (Muscular) -->
                        <rect x="25" y="60" width="50" height="40" rx="10" class="fur-grey" />
                        <path d="M30 65 L 70 65" stroke="#555" stroke-width="1" opacity="0.5" />
                        <!-- chest definition -->

                        <!-- Legs -->
                        <rect x="25" y="90" width="12" height="20" rx="3" class="fur-grey" />
                        <rect x="63" y="90" width="12" height="20" rx="3" class="fur-grey" />

                        <!-- Head -->
                        <g transform="translate(0, 10)">
                            <ellipse cx="50" cy="50" rx="25" ry="22" class="fur-grey" />
                            <!-- Ears -->
                            <ellipse cx="32" cy="38" rx="6" ry="8" class="fur-grey" />
                            <ellipse cx="68" cy="38" rx="6" ry="8" class="fur-grey" />
                            <!-- Chest Patch -->
                            <ellipse cx="50" cy="65" rx="10" ry="8" class="fur-white-patch" />
                            <!-- Face -->
                            <circle cx="42" cy="48" r="3" fill="#000" />
                            <circle cx="58" cy="48" r="3" fill="#000" />
                            <ellipse cx="50" cy="58" rx="4" ry="3" fill="#000" />
                            <path d="M45 60 L 50 62 L 55 60" fill="none" stroke="#000" stroke-width="2" />
                            <!-- Hard Hat -->
                            <ellipse cx="50" cy="32" rx="22" ry="10" class="hard-hat" />
                            <rect x="28" y="38" width="44" height="4" class="hard-hat" rx="1" />
                            <!-- Collar -->
                            <ellipse cx="50" cy="68" rx="18" ry="5" class="collar-blue" />
                            <circle cx="50" cy="68" r="3" fill="#ffd700" />
                        </g>
                    </svg>
                </div>
                <div class="char-name">Pitbull</div>
                <div class="char-desc">Pure Hustle, No Shortcuts</div>
                <div class="char-stats">
                    <div class="stat-row"><span class="stat-label">üí∞ Income</span><span class="stat-value">105%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üõ°Ô∏è Defense</span><span class="stat-value">90%</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">üìä Passive Income</span><span
                            class="stat-value">65%</span></div>
                    <div class="special-ability">
                        <div class="ability-name">OVERTIME GRIND</div>
                        <div class="ability-desc">‚Ä¢ Active collection +25% coin value<br>‚Ä¢ High combos boost income
                            permanently<br>‚Ä¢ Missed runs reduce combo bonuses<br>‚Ä¢ No passive scaling bonuses</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Path selection -->
    <div id="path-selection">
        <h2>Choose Your Path</h2>
        <div class="section">
            <div class="path-option">
                <div class="btn btn-tech" title="Tech Path" onclick="selectPath('tech')">
                    <svg viewBox="0 0 24 24">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                        <path d="M2 10h4v4h-4z" opacity="0.5" />
                    </svg>
                </div>
                <p class="path-label">Tech</p>
            </div>

            <div class="path-option">
                <div class="btn btn-creative" title="Creative Path" onclick="selectPath('creative')">
                    <div class="icon-creative">üé®</div>
                </div>
                <p class="path-label">Creative</p>
            </div>

            <div class="path-option">
                <div class="btn btn-corporate" title="Corporate Path" onclick="selectPath('corporate')">
                    <div class="icon-briefcase"></div>
                </div>
                <p class="path-label">Corporate</p>
            </div>
        </div>
    </div>



    <script>
        const c = document.getElementById('c');
        const ctx = c.getContext('2d');
        const ui = document.getElementById('ui');

        const staticCityCvs = document.createElement('canvas');
        const staticCityCtx = staticCityCvs.getContext('2d');

        let w, h;

        // Game State
        let gameState = 'TITLE'; // TITLE, CHARACTERS, PATHS, PLAYING, DILEMMA, SHOP, GAMEOVER
        let gameTime = 0;
        let score = 0;
        let gameTimer = 0;
        const GAME_INTERVAL = 15; // 15 seconds

        // Player Class Stats
        let playerClass = null;
        let income = 1.0;
        let defense = 1.0;
        let passiveIncome = 1.0;

        // Player Path
        let playerPath = null;
        let cityScroll = 0; // Tracks background scrolling range [0, -w]

        // Player
        const player = {
            x: 50,
            y: 0,
            size: 85,
            vy: 0,
            gravity: 0.3,
            thrust: -0.3,
            maxVy: 12,
            isThrusting: false,
            health: 100,
            maxHealth: 100,
            money: 0,
            character: null,
            anim: { type: 'none', timer: 0, maxTime: 0, active: false }
        };

        // Entities
        let obstacles = [];
        let coins = [];
        let obstacleTimer = 0;
        let coinTimer = 0;

        // Resize function consolidated below
        // window.addEventListener('resize', resize);
        // resize();

        // Input Handling
        function startThrust(e) {
            if (e.type === 'mousedown' || e.type === 'touchstart') {
                player.isThrusting = true;
                if (gameState === 'GAMEOVER') resetGame();
            }
        }

        function endThrust(e) {
            if (e.type === 'mouseup' || e.type === 'touchend') {
                player.isThrusting = false;
            }
        }

        window.addEventListener('mousedown', startThrust);
        window.addEventListener('touchstart', startThrust);
        window.addEventListener('mouseup', endThrust);
        window.addEventListener('touchend', endThrust);

        document.getElementById('playBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            showCharacterSelection();
        });

        function showCharacterSelection() {
            gameState = 'CHARACTERS';
            ui.style.display = 'none';
            document.querySelector('.timer-display').style.display = 'none';
            document.getElementById('character-selection').classList.add('active');
        }

        function selectCharacter(characterType) {
            // Store selected character
            player.character = characterType;
            playerClass = characterType;

            // Set stats based on character
            switch (characterType) {
                case 'scotty':
                    income = 0.95;
                    defense = 1.30;
                    passiveIncome = 1.20;
                    break;
                case 'husky':
                    income = 1.40;
                    defense = 0.65;
                    passiveIncome = 0.75;
                    break;
                case 'golden':
                    income = 0.75;
                    defense = 0.95;
                    passiveIncome = 1.65;
                    break;
                case 'corgi':
                    income = 1.20;
                    defense = 1.10;
                    passiveIncome = 1.35;
                    break;
                case 'shiba':
                    income = 0.85;
                    defense = 1.50;
                    passiveIncome = 0.95;
                    break;
                case 'pitbull':
                    income = 1.05;
                    defense = 0.90;
                    passiveIncome = 0.65;
                    break;
            }

            // Serialize SVG to Image with Computed Styles
            const svg = document.querySelector(`.${characterType}-svg`);
            if (svg) {
                // Clone the node to modify without affecting DOM
                const clone = svg.cloneNode(true);

                // Helper to inline styles
                function inlineComputedStyles(source, target) {
                    const computed = window.getComputedStyle(source);
                    const properties = [
                        'fill', 'stroke', 'stroke-width', 'opacity',
                        'filter', 'transform', 'transform-origin'
                    ];
                    for (const prop of properties) {
                        target.style[prop] = computed[prop];
                    }
                    for (let i = 0; i < source.children.length; i++) {
                        if (target.children[i]) {
                            inlineComputedStyles(source.children[i], target.children[i]);
                        }
                    }
                }

                inlineComputedStyles(svg, clone);

                let xml = new XMLSerializer().serializeToString(clone);

                // Inject Global Defs (Gradients)
                const hiddenSvg = document.querySelector('#character-selection > svg');
                if (hiddenSvg) {
                    const defs = hiddenSvg.querySelector('defs');
                    if (defs) {
                        // Clone defs to avoid moving it
                        const defsXml = new XMLSerializer().serializeToString(defs.cloneNode(true));
                        // Insert after opening tag
                        xml = xml.replace('>', '>' + defsXml);
                    }
                }

                // Ensure xmlns is present
                if (!xml.includes('xmlns=')) {
                    xml = xml.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                const svg64 = btoa(xml);
                const b64Start = 'data:image/svg+xml;base64,';
                const image64 = b64Start + svg64;

                player.sprite = new Image();
                player.sprite.src = image64;
            }

            document.getElementById('character-selection').classList.remove('active');
            showPathSelection();
        }

        function showPathSelection() {
            gameState = 'PATHS';
            ui.style.display = 'none';
            document.querySelector('.timer-display').style.display = 'none';
            const pathDiv = document.getElementById('path-selection');
            pathDiv.classList.add('active');
        }

        function selectPath(pathType) {
            playerPath = pathType;
            document.getElementById('path-selection').classList.remove('active');
            initializeGame();
            startRunner();
        }

        function initializeGame() {
            player.y = h / 2;
            player.vy = 0;
            player.isThrusting = false;
            player.health = 100;
            player.money = 0;
            obstacles = [];
            coins = [];
            score = 0;
            gameTimer = 0;

            // Reset Animation
            player.anim = { type: 'none', timer: 0, maxTime: 0, active: false };

            // Regenerate City & Reset Scroll
            cityScroll = 0;
            initCity();
            drawStaticCity();
        }

        function startRunner() {
            gameState = 'PLAYING';
            ui.style.display = 'none';
            document.querySelector('.timer-display').style.display = 'block';
        }

        function resetGame() {
            gameState = 'TITLE';
            ui.style.display = 'block';
            document.querySelector('.timer-display').style.display = 'none';
            document.getElementById('shop-ui').classList.remove('active');
            document.getElementById('character-selection').classList.remove('active');
            document.getElementById('path-selection').classList.remove('active');
            // Clear DOM obstacles
            const overlay = document.getElementById('game-overlay');
            if (overlay) overlay.innerHTML = '';
        }

        // Buy Item Function
        function buyItem(name, cost, health) {
            const msg = document.getElementById('status-msg');

            // Check if player has enough money
            if (player.money < cost) {
                msg.textContent = `Not enough money! Need $${cost}, have $${player.money}`;
                msg.style.color = '#ff0000';
                msg.style.opacity = 1;
                setTimeout(() => {
                    msg.style.opacity = 0;
                }, 2000);
                return;
            }

            // Check if player is already at full health
            if (player.health >= player.maxHealth) {
                msg.textContent = `Already at full health!`;
                msg.style.color = '#ffaa00';
                msg.style.opacity = 1;
                setTimeout(() => {
                    msg.style.opacity = 0;
                }, 2000);
                return;
            }

            // Deduct money
            player.money -= cost;

            // Restore health (FULL HP restores to max, otherwise add health value)
            if (health === 100) {
                player.health = player.maxHealth;
            } else {
                player.health = Math.min(player.health + health, player.maxHealth);
            }

            // Show success message
            msg.textContent = `Purchased ${name} for $${cost}! Restored ${health === 100 ? 'FULL' : health} HP.`;
            msg.style.color = '#00ff41';
            msg.style.opacity = 1;

            // Update shop stats display
            updateShopStats();
            updateAffordability();

            setTimeout(() => {
                msg.style.opacity = 0;
            }, 2000);

            console.log(`Bought ${name}: -$${cost}, +${health} HP`);
        }

        // Update Shop Stats Display
        function updateShopStats() {
            document.getElementById('shop-balance').textContent = `$${player.money}`;
            document.getElementById('shop-health').textContent = `${player.health}/${player.maxHealth}`;
        }

        // Update affordability - gray out items player can't afford
        function updateAffordability() {
            document.querySelectorAll('.shop-item').forEach(item => {
                const costText = item.querySelector('.item-cost').textContent;
                const cost = parseInt(costText.replace(/[^0-9]/g, ''));
                if (player.money < cost) {
                    item.classList.add('too-expensive');
                } else {
                    item.classList.remove('too-expensive');
                }
            });
            if (currentSkill) {
                const skill = skillData[currentSkill];
                const buyBtn = document.getElementById('popup-buy-btn');
                if (skill && player.money < skill.price) {
                    buyBtn.classList.add('too-expensive');
                } else if (buyBtn) {
                    buyBtn.classList.remove('too-expensive');
                }
            }
        }

        // ========== CARDS TAB LOGIC ==========
        const cardsDecisions = [
            {
                scenario: "First Paycheck!",
                optionA: {
                    title: "Buy New Collar",
                    icon: "üéÄ",
                    effect: "Visual cosmetic change only: no stat benefits!",
                    result: "You look fabulous, but your future self might have preferred some savings...",
                    stats: { money: 0, income: 0, defense: 0, passiveIncome: 0 }
                },
                optionB: {
                    title: "Start 401k",
                    icon: "üìà",
                    effect: "-$100 Cash, but Passive Income +5% permanently!",
                    result: "Smart! Your future self thanks you. Compound interest is now your best friend.",
                    stats: { money: -100, income: 0, defense: 0, passiveIncome: 0.05 }
                }
            },
            {
                scenario: "Car Breaks Down",
                optionA: {
                    title: "Put on Credit Card",
                    icon: "üí≥",
                    effect: "Keep your cash now, but Income -10% due to interest payments!",
                    result: "The debt trap closes in... Interest payments will haunt you for years.",
                    stats: { money: 0, income: -0.10, defense: 0, passiveIncome: 0 }
                },
                optionB: {
                    title: "Pay Cash",
                    icon: "üíµ",
                    effect: "-$500 Cash immediately, but Defense +10% from financial security!",
                    result: "Pain now, gain later! No debt means freedom to grow your wealth.",
                    stats: { money: -500, income: 0, defense: 0.10, passiveIncome: 0 }
                }
            },
            {
                scenario: "Student Loans",
                optionA: {
                    title: "Defer Payment",
                    icon: "‚è∞",
                    effect: "Keep your cash for now, but Passive Income -15% as interest compounds!",
                    result: "The debt grows silently. It's always watching, always growing.",
                    stats: { money: 0, income: 0, defense: 0, passiveIncome: -0.15 }
                },
                optionB: {
                    title: "Pay Aggressively",
                    icon: "‚öîÔ∏è",
                    effect: "-75% of current Cash, but Income +20% permanently!",
                    result: "Debt-free! With no monthly payments, your income potential skyrockets.",
                    stats: { money: 'percent', moneyPercent: -0.75, income: 0.20, defense: 0, passiveIncome: 0 }
                }
            },
            {
                scenario: "Weekend Vibes",
                optionA: {
                    title: "Party All Night",
                    icon: "ü•≥",
                    effect: "+$100 Cash from networking, but Income -5% from lost productivity!",
                    result: "YOLO! Great memories made, but money doesn't grow while you sleep it off.",
                    stats: { money: 100, income: -0.05, defense: 0, passiveIncome: 0 }
                },
                optionB: {
                    title: "Take Online Course",
                    icon: "üéì",
                    effect: "-$200 Cash, but Income +15% permanently!",
                    result: "Knowledge is power! New skills unlock higher earning potential.",
                    stats: { money: -200, income: 0.15, defense: 0, passiveIncome: 0 }
                }
            },
            {
                scenario: "Tax Refund Season üí∞",
                optionA: {
                    title: "YOLO on Crypto",
                    icon: "üöÄ",
                    effect: "50% chance to 2x your Cash... 50% chance to lose it ALL and Defense -10%!",
                    result: "To the moon... or to the ground. Fortune favors the bold (sometimes).",
                    stats: { money: 'gamble', income: 0, defense: 0, passiveIncome: 0 }
                },
                optionB: {
                    title: "High Yield Savings",
                    icon: "üõ°Ô∏è",
                    effect: "+$200 Cash and Defense +20% from emergency fund security!",
                    result: "Safe and protected! Your emergency fund shields you from life's surprises.",
                    stats: { money: 200, income: 0, defense: 0.20, passiveIncome: 0 }
                }
            },
            {
                scenario: "The Promotion! üèÜ",
                optionA: {
                    title: "Buy Luxury Condo",
                    icon: "üè†",
                    effect: "-$1000 Cash and Income -15% from higher expenses!",
                    result: "Living large has its costs... Your expenses grow with your income.",
                    stats: { money: -1000, income: -0.15, defense: 0, passiveIncome: 0 }
                },
                optionB: {
                    title: "Stay in Apartment",
                    icon: "üè¢",
                    effect: "Keep your Cash and gain +20% Passive Income from investing the difference!",
                    result: "Humble living, wealthy building! You resist the temptation to inflate your lifestyle.",
                    stats: { money: 0, income: 0, defense: 0, passiveIncome: 0.20 }
                }
            },
            {
                scenario: "Market Crash! üìâ",
                optionA: {
                    title: "Sell Everything!",
                    icon: "üò±",
                    effect: "+$2000 Cash immediately, but Passive Income -100% (drops to 0)!",
                    result: "Panic sold at the bottom... The market always recovers, but you won't.",
                    stats: { money: 2000, income: 0, defense: 0, passiveIncome: -1.0 }
                },
                optionB: {
                    title: "Hold & Buy Dip",
                    icon: "üíé",
                    effect: "-$500 Cash to buy the dip, but Passive Income +50%!",
                    result: "Diamond hands! Buying when others panic is how millionaires are made.",
                    stats: { money: -500, income: 0, defense: 0, passiveIncome: 0.50 }
                }
            },
            {
                scenario: "Health Scare üè•",
                optionA: {
                    title: "Risk It",
                    icon: "üé≤",
                    effect: "Save your Cash, but Defense -30% from lack of coverage!",
                    result: "Living dangerously... One wrong move and it's all over.",
                    stats: { money: 0, income: 0, defense: -0.30, passiveIncome: 0 }
                },
                optionB: {
                    title: "Buy Insurance",
                    icon: "‚ù§Ô∏è",
                    effect: "-$1000 Cash, but Defense +40% from comprehensive coverage!",
                    result: "Protected! Insurance isn't fun, but it's the adult thing to do.",
                    stats: { money: -1000, income: 0, defense: 0.40, passiveIncome: 0 }
                }
            }
        ];

        let currentCardDecision = null;

        function startDilemma() {
            // Pick a random decision
            const randomIndex = Math.floor(Math.random() * cardsDecisions.length);
            currentCardDecision = cardsDecisions[randomIndex];
            renderCard(currentCardDecision);
        }

        function renderCard(decision) {
            // Randomly swap colors for options
            const randomSwap = Math.random() > 0.5;
            const classA = randomSwap ? 'option-smart' : 'option-risky';
            const classB = randomSwap ? 'option-risky' : 'option-smart';

            const container = document.getElementById('cardContainer');
            container.innerHTML = `
                <div class="decision-card">
                    <div class="card-header">
                        <h2 class="scenario-title">${decision.scenario}</h2>
                    </div>

                    <div class="options-grid">
                        <div class="option-card ${classA}" onclick="selectCardOption('A')">
                            <span class="option-icon">${decision.optionA.icon}</span>
                            <h3 class="option-title">${decision.optionA.title}</h3>
                            <p class="option-effect">${decision.optionA.effect}</p>
                        </div>

                        <div class="option-card ${classB}" onclick="selectCardOption('B')">
                            <span class="option-icon">${decision.optionB.icon}</span>
                            <h3 class="option-title">${decision.optionB.title}</h3>
                            <p class="option-effect">${decision.optionB.effect}</p>
                        </div>
                    </div>

                    <div class="result-message" id="resultMessage">
                        <h3 id="resultTitle"></h3>
                        <p id="resultText"></p>
                    </div>

                    <button class="continue-btn" id="continueBtn" onclick="continueCardGame()">
                        Continue to Shop ‚Üí
                    </button>
                </div>
            `;
        }

        function selectCardOption(option) {
            const decision = currentCardDecision;
            const cards = document.querySelectorAll('#cards-tab .option-card');
            const resultMessage = document.getElementById('resultMessage');
            const resultTitle = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');
            const continueBtn = document.getElementById('continueBtn');

            // Prevent changing selection after making a choice
            if (continueBtn.classList.contains('show')) {
                return;
            }

            const selectedOption = option === 'A' ? decision.optionA : decision.optionB;
            const stats = selectedOption.stats;

            // Apply stat changes
            if (stats.money === 'percent') {
                player.money = Math.floor(player.money * (1 + stats.moneyPercent));
            } else if (stats.money === 'gamble') {
                // Crypto gamble
                if (Math.random() > 0.5) {
                    player.money *= 2;
                    resultText.textContent = `üöÄ TO THE MOON! Your crypto doubled! ${selectedOption.result}`;
                } else {
                    player.money = 0;
                    defense -= 0.10;
                    resultText.textContent = `üìâ REKT! Lost everything! ${selectedOption.result}`;
                }
            } else {
                player.money += stats.money;
            }

            income += stats.income;
            defense += stats.defense;
            passiveIncome += stats.passiveIncome;

            // Ensure stats don't go below minimum values
            income = Math.max(0.1, income);
            defense = Math.max(0.1, defense);
            passiveIncome = Math.max(0, passiveIncome);
            player.money = Math.max(0, player.money);

            if (option === 'A') {
                cards[0].classList.add('selected');
                resultMessage.className = 'result-message show risky';
                resultTitle.textContent = 'You chose Option A!';
                if (stats.money !== 'gamble') {
                    resultText.textContent = selectedOption.result;
                }
            } else {
                cards[1].classList.add('selected');
                resultMessage.className = 'result-message show smart';
                resultTitle.textContent = 'You chose Option B!';
                resultText.textContent = selectedOption.result;
            }

            continueBtn.classList.add('show');

            // Disable clicking on cards after selection
            cards.forEach(card => {
                card.style.pointerEvents = 'none';
                if (!card.classList.contains('selected')) {
                    card.style.opacity = '0.4';
                }
            });

            console.log(`Card choice made. Stats: Income ${income.toFixed(2)}, Defense ${defense.toFixed(2)}, PassiveIncome ${passiveIncome.toFixed(2)}, Money $${player.money}`);
        }

        function continueCardGame() {
            // Transition to SHOP after making dilemma choice
            gameState = 'SHOP';
            // Restore nav bar and close button
            document.querySelector('.nav-bar').style.display = '';
            document.getElementById('closeShop').style.display = '';
            // Switch to skills tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="skills"]').classList.add('active');
            document.getElementById('skills-tab').classList.add('active');
            drawSkillsTree();
            updateShopStats();
            updateAffordability();
        }

        // Draw Skills Tree - shows the correct tree based on playerPath
        function drawSkillsTree() {
            // Hide all trees first
            document.getElementById('tech-tree').style.display = 'none';
            document.getElementById('creative-tree').style.display = 'none';
            document.getElementById('corporate-tree').style.display = 'none';

            // Show the tree matching the player's chosen path
            if (playerPath === 'tech') {
                document.getElementById('tech-tree').style.display = 'flex';
            } else if (playerPath === 'creative') {
                document.getElementById('creative-tree').style.display = 'flex';
            } else if (playerPath === 'corporate') {
                document.getElementById('corporate-tree').style.display = 'flex';
            }

            // Initialize skill click handlers
            initSkillClickHandlers();
        }

        // UI Event Listeners
        document.getElementById('closeShop').addEventListener('click', () => {
            document.getElementById('shop-ui').classList.remove('active');
            gameTimer = 0;
            startRunner();
        });

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');

                if (tab.dataset.tab === 'skills') drawSkillsTree();
            });
        });

        // --- Configuration ---
        const config = {
            cycleDuration: 120000,
            waterLevel: 0.75 // Water starts at 75% height
        };

        let startTime = null;

        const skyCvs = document.getElementById('sky-canvas');
        const auroraCvs = document.getElementById('aurora-canvas');
        const starsCvs = document.getElementById('stars-canvas');
        const cityCvs = document.getElementById('city-canvas');
        const reflectCvs = document.getElementById('reflection-canvas');

        const skyCtx = skyCvs.getContext('2d');
        const auroraCtx = auroraCvs.getContext('2d');
        const starsCtx = starsCvs.getContext('2d');
        const cityCtx = cityCvs.getContext('2d');
        const reflectCtx = reflectCvs.getContext('2d');

        function resize() {
            w = c.width = window.innerWidth;
            h = c.height = window.innerHeight;

            [skyCvs, auroraCvs, starsCvs, cityCvs, reflectCvs].forEach(c => {
                c.width = window.innerWidth;
                c.height = window.innerHeight;
            });

            if (gameState === 'TITLE') player.y = h / 2;

            initStars();
            initCity();
            drawStaticCity(); // Call after initCity to draw buildings
        }
        window.addEventListener('resize', resize);

        // --- VIBRANT NYC SUNSET GRADIENTS ---
        const skyColors = [
            { pos: 0.0, stops: [{ r: 44, g: 62, b: 80 }, { r: 255, g: 94, b: 77 }] }, // Integrated some reds/oranges from image
            { pos: 0.15, stops: [{ r: 50, g: 40, b: 70 }, { r: 214, g: 50, b: 48 }] }, // Deep Red/Purple
            { pos: 0.3, stops: [{ r: 30, g: 30, b: 60 }, { r: 150, g: 50, b: 150 }] },
            { pos: 0.45, stops: [{ r: 10, g: 10, b: 35 }, { r: 60, g: 30, b: 80 }] },
            { pos: 0.6, stops: [{ r: 2, g: 2, b: 10 }, { r: 20, g: 20, b: 40 }] },
            { pos: 0.85, stops: [{ r: 20, g: 20, b: 40 }, { r: 70, g: 70, b: 100 }] },
            { pos: 1.0, stops: [{ r: 64, g: 64, b: 92 }, { r: 138, g: 118, b: 171 }] }
        ];

        function lerp(a, b, t) { return a + (b - a) * t; }
        function getInterpColor(c1, c2, t) {
            return `rgb(${lerp(c1.r, c2.r, t)}, ${lerp(c1.g, c2.g, t)}, ${lerp(c1.b, c2.b, t)})`;
        }

        function drawSky(progress) {
            let start = skyColors[0];
            let end = skyColors[skyColors.length - 1];

            for (let i = 0; i < skyColors.length - 1; i++) {
                if (progress >= skyColors[i].pos && progress < skyColors[i + 1].pos) {
                    start = skyColors[i];
                    end = skyColors[i + 1];
                    break;
                }
            }

            const range = end.pos - start.pos;
            const t = (progress - start.pos) / range;

            const c1 = getInterpColor(start.stops[0], end.stops[0], t);
            const c2 = getInterpColor(start.stops[1], end.stops[1], t);

            const grd = skyCtx.createLinearGradient(0, 0, 0, skyCvs.height * config.waterLevel);
            grd.addColorStop(0, c1);
            grd.addColorStop(1, c2);
            skyCtx.fillStyle = grd;
            skyCtx.fillRect(0, 0, skyCvs.width, skyCvs.height * config.waterLevel);
        }

        // --- Stars ---
        let bgStars = [];
        function initStars() {
            bgStars = [];
            for (let i = 0; i < 300; i++) {
                const isShiny = Math.random() < 0.1;
                bgStars.push({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * (window.innerHeight * config.waterLevel),
                    size: isShiny ? Math.random() * 2 + 1 : Math.random() * 1.5,
                    opacity: Math.random(),
                    twinkleSpeed: (Math.random() * 0.05 + 0.01) * (isShiny ? 2000 : 1),
                    isShiny: isShiny
                });
            }
        }

        function drawStars() {
            starsCtx.clearRect(0, 0, starsCvs.width, starsCvs.height);
            bgStars.forEach(s => {
                s.opacity += 0.005;
                const val = Math.abs(Math.sin(performance.now() * 0.001 * s.twinkleSpeed + s.x));

                starsCtx.shadowBlur = s.isShiny ? 8 : 0;
                starsCtx.shadowColor = 'white';
                starsCtx.fillStyle = `rgba(255, 255, 255, ${val})`;
                starsCtx.beginPath();
                starsCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                starsCtx.fill();
            });
            starsCtx.shadowBlur = 0;
        }

        // --- City & Traffic ---
        let buildings = [];
        let cars = [];

        function initCity() {
            buildings = [];
            let currentX = 0;
            const groundY = window.innerHeight * config.waterLevel;

            while (currentX < window.innerWidth) {
                let width, height, shape = 'flattop';
                const rand = Math.random();

                // Varied Shapes inspired by NY
                if (rand > 0.85) { shape = 'empire'; width = 80; height = 400 + Math.random() * 100; } // Empire State
                else { shape = 'block'; width = 50 + Math.random() * 80; height = 150 + Math.random() * 300; }

                if (currentX + width > window.innerWidth) width = window.innerWidth - currentX;
                if (width < 20) break;

                // Windows
                const winW = 6, winH = 9, gapX = 4, gapY = 6;
                const cols = Math.floor((width - 4) / (winW + gapX));
                const rows = Math.floor((height - 10) / (winH + gapY));
                const winArr = [];

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        let isOn = Math.random() > 0.5;

                        if (Math.random() > 0.3) {
                            winArr.push({ x: 4 + c * (winW + gapX), y: 10 + r * (winH + gapY), w: winW, h: winH, on: isOn, flickerOffset: Math.random() * 10000 });
                        }
                    }
                }

                buildings.push({ x: currentX, y: groundY - height, w: width, h: height, shape: shape, windows: winArr, colorIdx: Math.random() });
                currentX += width - 2;
            }

            // Init Cars
            cars = [];
            for (let i = 0; i < 40; i++) {
                cars.push({
                    x: Math.random() * window.innerWidth,
                    y: groundY - Math.random() * 5, // Just above water line
                    speed: Math.random() + 0.5,
                    dir: Math.random() > 0.5 ? 1 : -1,
                    color: Math.random() > 0.5 ? '#ff4444' : '#ffffff' // Tail vs Headlights
                });
            }
        }

        function drawStaticCity() {
            staticCityCvs.width = window.innerWidth;
            staticCityCvs.height = window.innerHeight;
            staticCityCtx.clearRect(0, 0, staticCityCvs.width, staticCityCvs.height);

            buildings.forEach(b => {
                const hue = 220 + b.colorIdx * 40;
                const grad = staticCityCtx.createLinearGradient(b.x, b.y, b.x, b.y + b.h);
                grad.addColorStop(0, `hsl(${hue}, 30%, 20%)`);
                grad.addColorStop(1, `hsl(${hue}, 40%, 5%)`);
                staticCityCtx.fillStyle = grad;

                staticCityCtx.beginPath();
                if (b.shape === 'empire') {
                    staticCityCtx.rect(b.x, b.y + 80, b.w, b.h - 80);
                    staticCityCtx.rect(b.x + b.w * 0.15, b.y + 40, b.w * 0.7, 40);
                    staticCityCtx.rect(b.x + b.w * 0.35, b.y, b.w * 0.3, 40);
                    staticCityCtx.rect(b.x + b.w / 2 - 2, b.y - 30, 4, 30);
                } else {
                    staticCityCtx.rect(b.x, b.y, b.w, b.h);
                }
                staticCityCtx.fill();
            });
        }

        function drawCity() {
            cityCtx.clearRect(0, 0, cityCvs.width, cityCvs.height);
            reflectCtx.clearRect(0, 0, reflectCvs.width, reflectCvs.height);

            // Scroll City
            cityScroll -= 2; // Speed
            if (cityScroll <= -w) cityScroll += w;

            // Draw Tiled Background (2 copies to cover scroll)
            cityCtx.drawImage(staticCityCvs, cityScroll, 0);
            cityCtx.drawImage(staticCityCvs, cityScroll + w, 0);

            const groundY = window.innerHeight * config.waterLevel;

            // Draw Dynamic Elements (Windows) Twice for both tiles
            [cityScroll, cityScroll + w].forEach(offsetX => {
                // Optimization: Skip if off-screen completely
                if (offsetX > w || offsetX + w < 0) return;

                buildings.forEach(b => {
                    // Windows (Dynamic)
                    b.windows.forEach(win => {
                        if (!win.on) return;
                        let alpha = Math.abs(Math.sin((performance.now() + win.flickerOffset) * 0.002)) * 0.5 + 0.3;
                        cityCtx.globalAlpha = alpha;
                        cityCtx.fillStyle = '#ffebcc';
                        cityCtx.fillRect(b.x + win.x + offsetX, b.y + win.y, win.w, win.h);
                    });
                    cityCtx.globalAlpha = 1;
                });
            });


            // Street Lamps & Roads (Partially static, but keep for now or move to static)
            cityCtx.fillStyle = '#000';
            cityCtx.fillRect(0, groundY - 5, window.innerWidth, 5);

            for (let x = 20; x < window.innerWidth; x += 100) {
                // Scroll lamps too? If so, need to offset.
                // For simplicity, let's make lamps static to the screen (like a UI overlay) or scroll them.
                // Let's scroll them to match the city movement
                let lampX = (x + cityScroll) % window.innerWidth;
                if (lampX < 0) lampX += window.innerWidth;

                cityCtx.fillStyle = '#444';
                cityCtx.fillRect(lampX, groundY - 40, 3, 40);
                cityCtx.fillStyle = '#ffaa00';
                cityCtx.shadowBlur = 10;
                cityCtx.shadowColor = '#ffaa00';
                cityCtx.beginPath();
                cityCtx.arc(lampX + 1.5, groundY - 42, 4, 0, Math.PI * 2);
                cityCtx.fill();
                cityCtx.shadowBlur = 0;
            }

            // Traffic - Cars move independently
            cars.forEach(car => {
                car.x += car.speed * car.dir;
                if (car.x > window.innerWidth) car.x = -20;
                if (car.x < -20) car.x = window.innerWidth;

                cityCtx.fillStyle = car.color;
                cityCtx.shadowBlur = 5;
                cityCtx.shadowColor = car.color;
                cityCtx.fillRect(car.x, car.y, 8, 3);
                cityCtx.shadowBlur = 0;
            });

            // Capture City for Reflection
            reflectCtx.drawImage(cityCvs, 0, 0);
        }

        // --- Aurora & Meteors ---
        let auroraTime = 0;
        function drawAurora() {
            auroraCtx.clearRect(0, 0, auroraCvs.width, auroraCvs.height);
            auroraTime += 0.002;
            const bands = 2;
            for (let i = 0; i < bands; i++) {
                auroraCtx.beginPath();
                const baseY = 150 + i * 80;
                for (let x = 0; x <= auroraCvs.width; x += 15) {
                    const noise = Math.sin(x * 0.001 + auroraTime) * 1.2 + Math.sin(x * 0.003 - auroraTime) * 0.5;
                    const y = baseY + noise * 40;
                    if (x === 0) auroraCtx.moveTo(x, y); else auroraCtx.lineTo(x, y);
                }
                auroraCtx.lineTo(auroraCvs.width, 0); auroraCtx.lineTo(0, 0); auroraCtx.closePath();
                const grad = auroraCtx.createLinearGradient(0, 0, 0, auroraCvs.height / 2);
                grad.addColorStop(0, 'rgba(0, 255, 128, 0)'); grad.addColorStop(1, 'rgba(0, 255, 128, 0.2)');
                auroraCtx.fillStyle = grad; auroraCtx.filter = 'blur(20px)'; auroraCtx.fill(); auroraCtx.filter = 'none';
            }
        }

        class Meteor {
            constructor() { this.reset(); }
            reset() { this.active = false; this.spawnTime = performance.now() + Math.random() * 10000 + 2000; this.speed = 15; }
            activate() { this.active = true; this.x = Math.random() * window.innerWidth; this.y = Math.random() * window.innerHeight * 0.3; this.size = Math.random() * 2 + 1; const angle = Math.PI / 4 + (Math.random() - 0.5); this.vx = Math.cos(angle) * this.speed; this.vy = Math.sin(angle) * this.speed; this.alpha = 1; }
            update() { if (!this.active) { if (performance.now() > this.spawnTime) this.activate(); return; } this.x += this.vx; this.y += this.vy; this.alpha -= 0.05; if (this.alpha <= 0) this.reset(); }
            draw() { if (!this.active || this.alpha <= 0) return; starsCtx.strokeStyle = `rgba(255,255,255,${this.alpha})`; starsCtx.lineWidth = this.size; starsCtx.beginPath(); starsCtx.moveTo(this.x, this.y); starsCtx.lineTo(this.x - this.vx * 2, this.y - this.vy * 2); starsCtx.stroke(); }
        }
        const meteors = [new Meteor(), new Meteor()];

        function frame(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = (elapsed % config.cycleDuration) / config.cycleDuration;

            drawSky(progress);
            drawCity(); // Handles reflection & traffic
            drawStars();
            meteors.forEach(m => { m.update(); m.draw(); });
            drawAurora();

            requestAnimationFrame(frame);
        }

        resize();
        requestAnimationFrame(frame);

        // Obstacle Types Configuration
        const OBSTACLE_TYPES = [
            { name: 'credit', html: '<div class="credit-card"><div class="card-stripe"></div><div class="card-chip"></div></div>', width: 60, height: 36 }, // Resized (was 90x55)
            { name: 'house', html: '<div class="house"><div class="house-door"></div></div>', width: 50, height: 50 },
            { name: 'latte', html: '<div class="coffee-cup"><div class="coffee-lid"></div><div class="coffee-handle"></div></div>', width: 40, height: 50 },
            { name: 'phone', html: '<div class="phone"><div class="phone-screen"></div><div class="phone-button"></div></div>', width: 45, height: 75 },
            { name: 'student', html: '<div class="grad-cap"><div class="cap-board"></div><div class="cap-top"></div><div class="cap-base"></div><div class="tassel"><div class="tassel-end"></div></div></div>', width: 60, height: 60 },
            { name: 'gamble', html: '<div class="poker-chip"><div class="chip-center">$</div></div>', width: 60, height: 60 },
            { name: 'health', html: '<div class="health-cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>', width: 60, height: 60 }
        ];

        // Obstacle Class
        class Obstacle {
            constructor() {
                // Pick random type
                const typeIdx = Math.floor(Math.random() * OBSTACLE_TYPES.length);
                const config = OBSTACLE_TYPES[typeIdx];

                this.type = config.name;

                // Random Size (0.8x to 1.3x)
                this.scale = 0.8 + Math.random() * 0.5;
                this.w = config.width * this.scale;
                this.h = config.height * this.scale;

                this.x = w;
                // Random Y position within game area
                // Avoid spawning too high or too low partially
                this.y = Math.random() * (h * config.waterLevel - this.h);
                // Fix: config.waterLevel is on global config object, not this config
                // Recalculate safe Y range based on global config
                const groundY = h * 0.75; // Using default 0.75 from config
                this.y = 50 + Math.random() * (groundY - 50 - this.h);

                this.markedForDeletion = false;

                // Create DOM Element
                this.element = document.createElement('div');
                this.element.className = 'obstacle-sprite';
                this.element.innerHTML = config.html;
                this.element.style.transform = `scale(${this.scale})`;

                // Append to overlay
                document.getElementById('game-overlay').appendChild(this.element);

                this.updatePosition();
            }

            updatePosition() {
                this.element.style.left = `${this.x}px`;
                this.element.style.top = `${this.y}px`;
            }

            remove() {
                this.markedForDeletion = true;
                if (this.element && this.element.parentNode) {
                    this.element.parentNode.removeChild(this.element);
                }
            }

            update() {
                this.x -= 3; // Speed (match existing speed)
                this.updatePosition();

                if (this.x + this.w < -100) {
                    this.remove();
                }
            }

            draw() {
                // No canvas drawing needed for sprites
                // Optional: Draw Debug Hitbox
                // ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                // ctx.strokeRect(this.x, this.y, this.w, this.h);
            }
        }

        // Coin Class
        class Coin {
            constructor() {
                this.size = 15;
                this.x = w;
                this.y = 50 + Math.random() * (h - 100);
                this.markedForDeletion = false;
                this.waffleOffset = Math.random() * 100;
            }
            update() {
                this.x -= 6;
                this.waffleOffset += 0.1;
                this.y += Math.sin(this.waffleOffset) * 0.5;
                if (this.x + this.size < 0) this.markedForDeletion = true;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x + this.size, this.y + this.size);

                // Outer Gold
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fillStyle = '#FFD700';
                ctx.fill();
                ctx.strokeStyle = '#DAA520';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Shine
                ctx.beginPath();
                ctx.arc(-4, -4, this.size * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.fill();

                // Inner Symbol
                ctx.fillStyle = '#DAA520';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('$', 0, 1);

                ctx.restore();
            }
        }

        // UI Drawing
        function drawUI() {
            const padding = 20;
            const barHeight = 20;
            const barWidth = 200;

            // Health Bar
            ctx.save();
            ctx.translate(padding, padding);

            // Heart Icon
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.moveTo(10, 10);
            ctx.bezierCurveTo(10, 3, 5, 0, 0, 0);
            ctx.bezierCurveTo(-5, 0, -10, 3, -10, 10);
            ctx.bezierCurveTo(-10, 20, 0, 30, 10, 40);
            ctx.bezierCurveTo(20, 30, 30, 20, 30, 10);
            ctx.bezierCurveTo(30, 3, 25, 0, 20, 0);
            ctx.bezierCurveTo(15, 0, 10, 3, 10, 10);
            ctx.fill();

            // Bar Background
            ctx.fillStyle = '#550000';
            ctx.fillRect(40, 5, barWidth, barHeight);

            // Health Fill
            ctx.fillStyle = '#ff0000';
            const healthPercent = Math.max(0, player.health / player.maxHealth);
            ctx.fillRect(40, 5, barWidth * healthPercent, barHeight);

            // Border
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(40, 5, barWidth, barHeight);

            ctx.restore();

            // Balance Bar
            ctx.save();
            ctx.translate(padding, padding + 60);

            // Money Icon ($)
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('$', 15, 30);

            // Balance Text
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 32px Courier New';
            ctx.textAlign = 'left';
            ctx.shadowColor = '#000';
            ctx.shadowBlur = 4;
            ctx.fillText(`$${player.money}`, 40, 30);
            ctx.shadowBlur = 0;

            ctx.restore();
        }

        // Collision Logic
        function checkCollisions() {
            // Obstacles
            for (let i = 0; i < obstacles.length; i++) {
                const obs = obstacles[i];
                if (
                    player.x < obs.x + obs.w &&
                    player.x + player.size > obs.x &&
                    player.y < obs.y + obs.h &&
                    player.y + player.size > obs.y
                ) {
                    const damage = Math.floor(20 / defense);
                    player.health -= damage;
                    triggerPlayerAnim('damage', 20);
                    Juice.shake = 20;
                    Juice.flash = 10;
                    Juice.freeze = 5;
                    obs.remove(); // Removes DOM element and marks for deletion
                    if (player.health <= 0) {
                        gameState = 'GAMEOVER';
                        triggerPlayerAnim('lose', 1000);
                    }
                }
            }

            // Coins
            for (let i = 0; i < coins.length; i++) {
                const c = coins[i];
                const coinSize = c.size * 2;
                if (
                    player.x < c.x + coinSize &&
                    player.x + player.size > c.x &&
                    player.y < c.y + coinSize &&
                    player.y + player.size > c.y
                ) {
                    player.money += Math.floor(100 * income);
                    triggerPlayerAnim('collect', 15);
                    Juice.shake = 5;
                    c.markedForDeletion = true;
                }
            }
        }


        // Scotty Dog (Title Screen Only)
        // ... (Keep existing dogSprite and drawDog)
        const dogSprite = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 3, 1, 1, 1, 1],
            [1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1],
            [0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 0, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0],
            [0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0],
            [0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0],
            [0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0]
        ];

        function drawDog(x, y, scale) {
            ctx.save();
            ctx.translate(x, y + Math.sin(Date.now() / 300) * 10);
            for (let r = 0; r < dogSprite.length; r++) {
                for (let c = 0; c < dogSprite[r].length; c++) {
                    const val = dogSprite[r][c];
                    if (val === 0) continue;
                    ctx.fillStyle = val === 1 ? '#111' : (val === 2 ? '#d00' : '#fff');
                    ctx.fillRect(c * scale, r * scale, scale, scale);
                }
            }
            ctx.restore();
        }

        // Juice Object
        const Juice = {
            shake: 0,
            flash: 0,
            freeze: 0,
            update: function () {
                // Decrement freeze
                if (this.freeze > 0) {
                    this.freeze--;
                    return true; // Frozen
                }
                // Decay shake
                if (this.shake > 0) {
                    this.shake *= 0.9;
                    if (this.shake < 0.5) this.shake = 0;
                }
                // Decrement flash
                if (this.flash > 0) this.flash--;
                return false; // Not frozen
            },
            preDraw: function () {
                if (this.shake > 0) {
                    const dx = (Math.random() - 0.5) * this.shake;
                    const dy = (Math.random() - 0.5) * this.shake;
                    ctx.save();
                    ctx.translate(dx, dy);
                }
            },
            postDraw: function () {
                if (this.shake > 0) ctx.restore();
                if (this.flash > 0) {
                    ctx.fillStyle = "rgba(255, 0, 0, " + (this.flash / 10) + ")";
                    ctx.fillRect(0, 0, w, h);
                }
            }
        };

        // Animation Helpers
        function triggerPlayerAnim(type, duration) {
            player.anim.type = type;
            player.anim.timer = duration;
            player.anim.maxTime = duration;
            player.anim.active = true;
        }

        function updatePlayerAnim() {
            if (!player.anim.active) return;
            player.anim.timer--;
            if (player.anim.timer <= 0) {
                player.anim.active = false;
                player.anim.type = 'none';
            }
        }

        function applyPlayerTransforms(ctx, cx, cy) {
            // Jump/Fall Squash & Stretch (Always active based on physics if not animating)
            if (!player.anim.active && gameState === 'PLAYING') {
                if (player.vy < -1) { // Jumping
                    ctx.translate(cx, cy);
                    ctx.scale(0.9, 1.1); // Stretch vertically
                    ctx.translate(-cx, -cy);
                } else if (player.vy > 1) { // Falling
                    ctx.translate(cx, cy);
                    ctx.scale(1.1, 0.9); // Squash vertically
                    ctx.translate(-cx, -cy);
                }
                return;
            }

            if (!player.anim.active) return;

            const t = 1 - (player.anim.timer / player.anim.maxTime); // 0 to 1
            ctx.translate(cx, cy);

            if (player.anim.type === 'damage') {
                // wobble
                const wobble = Math.sin(t * 20) * 5 * (1 - t);
                ctx.translate(wobble, 0);
                // rotate
                const rot = Math.sin(t * 15) * 0.1;
                ctx.rotate(rot);
                // filter
                ctx.filter = `drop-shadow(0 0 ${10 * (1 - t)}px red)`;
            } else if (player.anim.type === 'collect') {
                // scale pop
                const scale = 1 + Math.sin(t * Math.PI) * 0.3; // 1 -> 1.3 -> 1
                ctx.scale(scale, scale);
                // filter
                ctx.filter = `brightness(1.5) drop-shadow(0 0 ${15 * Math.sin(t * Math.PI)}px gold)`;
            } else if (player.anim.type === 'win') {
                const bounce = Math.abs(Math.sin(t * 10)) * -10;
                ctx.translate(0, bounce);
                ctx.rotate(Math.sin(t * 5) * 0.1);
                ctx.filter = `drop-shadow(0 0 10px #00f3ff)`;
            } else if (player.anim.type === 'lose') {
                ctx.filter = 'grayscale(100%) contrast(1.2)';
                ctx.rotate(0.1);
                ctx.translate(0, t * 20); // Sink down
            }

            ctx.translate(-cx, -cy);
        }

        // Loop
        function loop() {
            const frozen = Juice.update();

            // clearRect to let background show through
            ctx.clearRect(0, 0, w, h);

            Juice.preDraw();

            if (gameState === 'TITLE') {
                const scale = Math.min(w, h) / 40;
                const dogW = 16 * scale;
                drawDog((w - dogW) / 2, h * 0.25, scale);

            } else if (gameState === 'CHARACTERS') {
                // Pause game updates during character selection
                // Background animations continue via separate frame() loop
                Juice.postDraw();
                requestAnimationFrame(loop);
                return;

            } else if (gameState === 'PATHS') {
                // Pause game updates during path selection
                // Background animations continue via separate frame() loop
                Juice.postDraw();
                requestAnimationFrame(loop);
                return;

            } else if (gameState === 'PLAYING') {
                if (!frozen) {
                    // Timer Logic
                    gameTimer += 1 / 60; // Assuming 60fps
                    const timeRemaining = Math.max(0, Math.ceil(GAME_INTERVAL - gameTimer));
                    document.querySelector('.timer-display').textContent = timeRemaining;

                    if (gameTimer >= GAME_INTERVAL) {
                        // Generate passive income
                        const passiveEarnings = Math.floor(player.money * (passiveIncome * 0.1));
                        player.money += passiveEarnings;

                        gameState = 'DILEMMA';
                        document.getElementById('shop-ui').classList.add('active');
                        // Show cards dilemma (hide nav & close so user must choose)
                        document.querySelector('.nav-bar').style.display = 'none';
                        document.getElementById('closeShop').style.display = 'none';
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById('cards-tab').classList.add('active');
                        startDilemma();
                        Juice.postDraw();
                        requestAnimationFrame(loop);
                        return; // Pause game updates
                    }

                    // Player Physics
                    if (player.isThrusting) player.vy += player.thrust;
                    else player.vy += player.gravity;

                    if (player.vy > player.maxVy) player.vy = player.maxVy;
                    if (player.vy < -player.maxVy) player.vy = -player.maxVy;
                    player.y += player.vy;

                    if (player.y < 0) { player.y = 0; player.vy = 0; }
                    if (player.y > h - player.size) { player.y = h - player.size; player.vy = 0; }

                    // Spawning
                    obstacleTimer++;
                    if (obstacleTimer > 60) {
                        obstacles.push(new Obstacle());
                        obstacleTimer = 0;
                    }

                    coinTimer++;
                    if (coinTimer > 40) {
                        if (Math.random() > 0.5) coins.push(new Coin());
                        coinTimer = 0;
                    }
                }

                // Update & Draw Entities
                obstacles.forEach(o => {
                    if (!frozen) o.update();
                    o.draw();
                });
                if (!frozen) obstacles = obstacles.filter(o => !o.markedForDeletion);

                coins.forEach(c => {
                    if (!frozen) c.update();
                    c.draw();
                });
                if (!frozen) coins = coins.filter(c => !c.markedForDeletion);

                if (!frozen) checkCollisions();

                updatePlayerAnim();

                // Draw Player
                ctx.save();
                const cx = player.x + player.size / 2;
                const cy = player.y + player.size / 2;
                applyPlayerTransforms(ctx, cx, cy);

                if (player.sprite && player.sprite.complete) {
                    ctx.drawImage(player.sprite, player.x, player.y, player.size, player.size);
                } else {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(player.x, player.y, player.size, player.size);
                }
                ctx.restore();

                // Draw Floating Text for Collect
                if (player.anim.type === 'collect') {
                    ctx.save();
                    ctx.fillStyle = '#ffd700';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    const t = 1 - (player.anim.timer / player.anim.maxTime);
                    ctx.globalAlpha = 1 - t;
                    ctx.fillText('+üí∞', cx, player.y - 10 - (t * 30));
                    ctx.restore();
                }

                drawUI();

            } else if (gameState === 'DILEMMA') {
                // Pause game updates while showing dilemma
                // Background animations continue via separate frame() loop
                Juice.postDraw();
                requestAnimationFrame(loop);
                return;

            } else if (gameState === 'SHOP') {
                // Pause game updates while in shop
                // Background animations continue via separate frame() loop
                Juice.postDraw();
                requestAnimationFrame(loop);
                return;

            } else if (gameState === 'GAMEOVER') {
                ctx.fillStyle = '#fff';
                ctx.font = '40px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('GAME OVER', w / 2, h / 2);
                ctx.font = '20px Courier New';
                ctx.fillText(`Final Money: $${player.money}`, w / 2, h / 2 + 40);
                ctx.fillText('Click to Title', w / 2, h / 2 + 80);
            }

            Juice.postDraw();

            requestAnimationFrame(loop);
        }

        loop();

        // ========== SKILL DATA & HANDLERS ==========
        const skillData = {
            // Tech Path
            'code-rabbit': {
                name: 'Code Rabbit',
                description: 'Lightning-fast coding assistant that helps you write code at breakneck speeds.',
                buffs: ['üí∞ Income +10%'],
                debuffs: [],
                price: 500
            },
            'velocity-demon': {
                name: 'Velocity Demon',
                description: 'Push your development speed beyond mortal limits with demonic efficiency.',
                buffs: ['üí∞ Income +15%'],
                debuffs: [],
                price: 1200
            },
            'stackoverflow': {
                name: 'Stack Overflow Scholar',
                description: 'Gain instant access to infinite knowledge and never get stuck again.',
                buffs: ['üí∞ Income +25%'],
                debuffs: [],
                price: 1500
            },
            'caffeine': {
                name: 'Caffeine Overdrive',
                description: 'Channel the power of infinite coffee for extreme productivity.',
                buffs: ['üìä Passive Income +10%'],
                debuffs: ['‚ö†Ô∏è Damage Taken +8%'],
                price: 2000
            },
            'turbo': {
                name: 'Turbo Compiler',
                description: 'Compile and execute code at blazing speeds, but sacrifice some stability.',
                buffs: ['üí∞ Income +20%'],
                debuffs: ['üõ°Ô∏è Defense -15%'],
                price: 2500
            },
            'passive-bot': {
                name: 'Passive Income Bot',
                description: 'Automated revenue stream that generates money while you sleep.',
                buffs: ['üí∞ Income +20%', 'üìä Passive Income +15%'],
                debuffs: [],
                price: 3000
            },
            'api-mine': {
                name: 'API Goldmine',
                description: 'Tap into lucrative API integrations but expose yourself to more risks.',
                buffs: ['üí∞ Income +30%'],
                debuffs: ['‚ö†Ô∏è Damage Taken +10%'],
                price: 3500
            },
            // Creative Path
            'starving-artist': {
                name: 'Starving Artist',
                description: 'Pour your soul into your craft, sacrificing income for passion and resilience.',
                buffs: ['üìä Passive Income +15%', 'üõ°Ô∏è Defense +10%'],
                debuffs: ['üí∞ Income -10%'],
                price: 500
            },
            'content-machine': {
                name: 'Content Machine',
                description: 'Mass-produce creative content at the cost of personal speed.',
                buffs: ['üìä Passive Income +25%'],
                debuffs: [],
                price: 1200
            },
            'tank-artist': {
                name: 'Tank Artist',
                description: 'Build thick skin from criticism and become nearly indestructible.',
                buffs: ['üõ°Ô∏è Defense +20%'],
                debuffs: ['‚ö†Ô∏è Damage Taken +8%'],
                price: 1500
            },
            'royalty-checks': {
                name: 'Royalty Checks Forever',
                description: 'Create timeless work that generates passive income indefinitely.',
                buffs: ['üìä Passive Income +20%', 'üõ°Ô∏è Defense +10%'],
                debuffs: ['üí∞ Income -15%'],
                price: 2500
            },
            'set-forget': {
                name: 'Set It and Forget It',
                description: 'Automate your creative output completely, but move at a snail\'s pace.',
                buffs: ['üìä Passive Income +30%'],
                debuffs: [],
                price: 3000
            },
            'fortress-solitude': {
                name: 'Fortress of Solitude',
                description: 'Isolate yourself to perfect your craft with enhanced protection.',
                buffs: ['üõ°Ô∏è Defense +15%', 'üìä Passive Income +15%'],
                debuffs: ['üí∞ Income -20%'],
                price: 2800
            },
            'immovable-object': {
                name: 'Immovable Object',
                description: 'Become an unstoppable defensive force at the expense of all mobility.',
                buffs: ['üõ°Ô∏è Defense +30%'],
                debuffs: [],
                price: 3500
            },
            // Corporate Path
            'cubicle-warrior': {
                name: 'Cubicle Warrior',
                description: 'Master the art of corporate survival with steady income and protection.',
                buffs: ['üí∞ Income +15%', 'üõ°Ô∏è Defense +10%'],
                debuffs: [],
                price: 500
            },
            'promo-chaser': {
                name: 'Promotion Chaser',
                description: 'Climb the corporate ladder aggressively, sacrificing passive earnings.',
                buffs: ['üí∞ Income +25%'],
                debuffs: ['üìä Passive Income -15%'],
                price: 1200
            },
            'benefits-max': {
                name: 'Benefits Maximizer',
                description: 'Optimize your corporate benefits package for maximum protection.',
                buffs: ['üõ°Ô∏è Defense +20%'],
                debuffs: [],
                price: 1500
            },
            'bonus-hunter': {
                name: 'Performance Bonus Hunter',
                description: 'Target high-risk, high-reward performance bonuses.',
                buffs: ['üí∞ Income +20%', 'üõ°Ô∏è Defense +10%'],
                debuffs: ['‚ö†Ô∏è Damage Taken +10%'],
                price: 2500
            },
            'exec-fasttrack': {
                name: 'Executive Fast Track',
                description: 'Rocket to the top with aggressive income growth, sacrificing stability.',
                buffs: ['üí∞ Income +30%'],
                debuffs: ['üìä Passive Income -20%'],
                price: 3000
            },
            'corp-fortress': {
                name: 'Corporate Fortress',
                description: 'Build an impenetrable corporate defense with balanced income.',
                buffs: ['üõ°Ô∏è Defense +15%', 'üí∞ Income +15%'],
                debuffs: [],
                price: 3200
            },
            'safety-net': {
                name: 'Safety Net Supreme',
                description: 'Maximize job security and protection at the cost of immediate earnings.',
                buffs: ['üõ°Ô∏è Defense +25%'],
                debuffs: ['üí∞ Income -15%'],
                price: 2800
            }
        };

        let currentSkill = null;

        function showSkillPopup(skillId) {
            const skill = skillData[skillId];
            if (!skill) return;

            currentSkill = skillId;

            document.getElementById('popup-skill-name').textContent = skill.name;
            document.getElementById('popup-description').textContent = skill.description;
            document.getElementById('popup-price').textContent = skill.price;

            const statsContainer = document.getElementById('popup-stats');
            statsContainer.innerHTML = '';

            skill.buffs.forEach(buff => {
                const buffEl = document.createElement('span');
                buffEl.className = 'buff';
                buffEl.textContent = buff;
                statsContainer.appendChild(buffEl);
            });

            skill.debuffs.forEach(debuff => {
                const debuffEl = document.createElement('span');
                debuffEl.className = 'debuff';
                debuffEl.textContent = debuff;
                statsContainer.appendChild(debuffEl);
            });

            // Gray out buy button if can't afford
            const buyBtn = document.getElementById('popup-buy-btn');
            if (player.money < skill.price) {
                buyBtn.classList.add('too-expensive');
            } else {
                buyBtn.classList.remove('too-expensive');
            }

            document.getElementById('skill-popup').classList.add('active');
        }

        function closeSkillPopup() {
            document.getElementById('skill-popup').classList.remove('active');
            currentSkill = null;
        }

        function buySkill() {
            if (!currentSkill) return;
            const skill = skillData[currentSkill];

            if (player.money < skill.price) {
                return;
            }

            player.money -= skill.price;

            // Apply buffs/debuffs
            skill.buffs.forEach(buff => {
                const match = buff.match(/([+-]?\d+)%/);
                if (!match) return;
                const val = parseInt(match[1]) / 100;
                if (buff.includes('Income') && !buff.includes('Passive')) income += val;
                else if (buff.includes('Passive')) passiveIncome += val;
                else if (buff.includes('Defense')) defense += val;
            });
            skill.debuffs.forEach(debuff => {
                const match = debuff.match(/([+-]?\d+)%/);
                if (!match) return;
                const val = parseInt(match[1]) / 100;
                if (debuff.includes('Income') && !debuff.includes('Passive')) income -= val;
                else if (debuff.includes('Passive')) passiveIncome -= val;
                else if (debuff.includes('Defense')) defense -= val;
            });

            // Ensure minimums
            income = Math.max(0.1, income);
            defense = Math.max(0.1, defense);
            passiveIncome = Math.max(0, passiveIncome);

            updateShopStats();
            updateAffordability();
            closeSkillPopup();
            console.log(`Bought ${skill.name}: -$${skill.price}. Income ${income.toFixed(2)}, Defense ${defense.toFixed(2)}, Passive ${passiveIncome.toFixed(2)}`);
        }

        // Skill button -> skill ID mapping
        const skillButtonMap = {
            '.btn-code-rabbit': 'code-rabbit',
            '.btn-velocity-demon': 'velocity-demon',
            '.btn-stackoverflow': 'stackoverflow',
            '.btn-caffeine': 'caffeine',
            '.btn-turbo': 'turbo',
            '.btn-passive-bot': 'passive-bot',
            '.btn-api-mine': 'api-mine',
            '.btn-starving-artist': 'starving-artist',
            '.btn-content-machine': 'content-machine',
            '.btn-tank-artist': 'tank-artist',
            '.btn-royalty-checks': 'royalty-checks',
            '.btn-set-forget': 'set-forget',
            '.btn-fortress-solitude': 'fortress-solitude',
            '.btn-immovable-object': 'immovable-object',
            '.btn-cubicle-warrior': 'cubicle-warrior',
            '.btn-promo-chaser': 'promo-chaser',
            '.btn-benefits-max': 'benefits-max',
            '.btn-bonus-hunter': 'bonus-hunter',
            '.btn-exec-fasttrack': 'exec-fasttrack',
            '.btn-corp-fortress': 'corp-fortress',
            '.btn-safety-net': 'safety-net'
        };

        function initSkillClickHandlers() {
            Object.keys(skillButtonMap).forEach(selector => {
                const element = document.querySelector('#skills-tab ' + selector);
                if (element && !element.dataset.skillBound) {
                    element.dataset.skillBound = 'true';
                    element.addEventListener('click', function() {
                        showSkillPopup(skillButtonMap[selector]);
                    });
                }
            });
        }
    </script>
</body>

</html>